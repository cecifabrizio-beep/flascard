<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giapponese SRS v40.0 (Multi-Categoria)</title>
    <style>
        /* --- STILE GENERALE --- */
        body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        h1 { color: #1c1c1e; margin-bottom: 20px; text-align: center; font-size: 1.8rem; }
        .container { width: 100%; max-width: 600px; margin-bottom: 50px; }
        .card { background: #ffffff; padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .hidden { display: none !important; }

        /* --- EVIDENZIATORE --- */
        .hlt { background-color: #ffeb3b; color: #000; border-radius: 3px; padding: 0 2px; } 

        /* --- UI COMPONENTI --- */
        .input-box { width: 100%; padding: 12px; font-size: 1.1rem; border: 2px solid #ddd; border-radius: 12px; box-sizing: border-box; margin-bottom: 10px; text-align: center; }
        .input-box:focus { border-color: #007aff; outline: none; }
        .feedback-box { text-align: center; font-weight: bold; font-size: 1.2rem; padding: 15px; border-radius: 12px; margin: 15px 0; border: 2px solid transparent; }
        .fb-corretto { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .fb-sbagliato { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; color: white; margin-top: 5px; transition: 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-blue { background-color: #007aff; } .btn-green { background-color: #28a745; } .btn-orange { background-color: #fd7e14; } .btn-red { background-color: #dc3545; } .btn-purple { background-color: #af52de; } 
        .btn-gray { background-color: #e5e5ea; color: #333; font-size: 0.9rem; padding: 8px; width: auto; flex:1; }

        /* --- MENU NAVIGAZIONE --- */
        #main-nav { display: flex; gap: 8px; width: 100%; max-width: 600px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
        .nav-btn { flex: 1; padding: 12px; border: none; border-radius: 25px; background-color: #fff; color: #555; font-weight: 600; cursor: pointer; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .nav-btn.active { background-color: #007aff; color: white; box-shadow: 0 4px 8px rgba(0,122,255,0.3); }

        /* --- MULTI-CATEGORIA STILE --- */
        .cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; max-height: 200px; overflow-y: auto; padding: 5px; border: 1px solid #eee; border-radius: 12px; }
        .cat-option { padding: 10px; border: 1px solid #ddd; border-radius: 8px; text-align: center; cursor: pointer; font-size: 0.9rem; background: #fff; transition: 0.2s; user-select: none; }
        .cat-option.selected { background-color: #e7f3ff; border-color: #007aff; color: #007aff; font-weight: bold; box-shadow: 0 0 0 1px #007aff inset; }
        .cat-controls { display: flex; gap: 10px; margin-bottom: 15px; }

        /* --- NOTIFICHE & GRAMMATICA --- */
        #sync-status { position: fixed; top: 10px; right: 10px; padding: 10px 15px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; display: none; z-index: 1000; }
        .sync-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .sync-loading { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .gram-item { border: 1px solid #eee; border-radius: 12px; margin-bottom: 10px; overflow: hidden; background: #fff; }
        .gram-header { padding: 15px; background: #f8f9fa; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #333; }
        .gram-content { display: none; padding: 15px; border-top: 1px solid #eee; }
        .gram-example { background: #f0f8ff; padding: 10px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #007aff; }
        .gram-ex-jp { font-weight: bold; display: block; margin-bottom: 4px; } .gram-ex-rom { font-size: 0.9rem; color: #888; display: block; } .gram-ex-it { font-size: 0.95rem; color: #007aff; font-style: italic; }

        /* --- QUIZ LAYOUT --- */
        #choices-area { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .choice-btn { background: #f8f9fa; border: 2px solid #e9ecef; padding: 20px; font-size: 2rem; border-radius: 16px; cursor: pointer; font-weight: bold; color: #333; }
        .btn-correct { background-color: #d4edda !important; border-color: #28a745 !important; color: #155724 !important; }
        .btn-wrong { background-color: #f8d7da !important; border-color: #dc3545 !important; color: #721c24 !important; opacity: 0.6; }
        #prompt-principale, #prompt-scrittura { font-size: 3rem; margin: 5px 0; text-align: center; font-weight: 500; min-height: 60px; word-break: keep-all; }
        #prompt-secondario, #sub-scrittura { font-size: 1.1rem; color: #666; text-align: center; margin-bottom: 20px; min-height: 20px; font-style: italic; }
        
        /* --- CANVAS --- */
        #canvas-container { position: relative; margin: 10px auto 20px auto; width: 280px; height: 280px; border: 2px dashed #bbb; border-radius: 12px; background: #fff; touch-action: none; overflow: hidden; }
        canvas { width: 100%; height: 100%; border-radius: 12px; cursor: crosshair; }
        .soluzione-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 3.5rem; line-height: 1.2; text-align: center; flex-wrap: wrap; word-break: break-all; color: rgba(255, 0, 0, 0.2); pointer-events: none; font-family: "Yu Mincho", serif; padding: 10px; box-sizing: border-box; }
        .soluzione-visibile { color: rgba(40, 167, 69, 0.6) !important; z-index: 10; }

        /* --- LISTE --- */
        .list-entry { display: flex; align-items: flex-start; background: #ffffff; border-bottom: 1px solid #eee; padding: 15px 10px; gap: 15px; }
        .play-btn { width: 48px; height: 48px; border-radius: 50%; background: #007aff; color: white; border: none; font-size: 1.2rem; cursor: pointer; flex-shrink: 0; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 6px rgba(0,122,255,0.2); }
        .list-text { flex-grow: 1; }
        .txt-jpn { font-weight: bold; font-size: 1.25rem; display: block; color: #333; margin-bottom: 4px; }
        .txt-rom { font-size: 0.9rem; color: #888; display: block; margin-bottom: 6px; }
        .txt-ita { color: #007aff; font-size: 1rem; font-weight: 500; display: inline-block; background: #f0f8ff; padding: 5px 8px; border-radius: 6px; }
        .spoiler .txt-ita { background: #e0e0e0; color: transparent; user-select: none; } .spoiler .txt-ita:hover { background: #f0f8ff; color: #007aff; cursor: help; }
        
        .kana-table { width: 100%; border-collapse: collapse; text-align: center; margin-bottom: 20px; }
        .kana-table td { border: 1px solid #eee; padding: 8px; font-size: 1.1rem; } .kc { font-weight: bold; display: block; } .kr { font-size: 0.75rem; color: #999; }
        .deck-status { text-align: center; font-size: 0.9rem; color: #666; margin-top: 5px; font-weight: 500; }
        .deck-badge { background: #e0e0e0; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 5px; }
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .mix-toggle { background: #e7f3ff; border: 1px solid #007aff; color: #007aff; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-weight: bold; display: flex; align-items: center; gap: 10px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="sync-status"></div>
    <h1>Set di Studio Giapponese</h1>
    <nav id="main-nav">
        <button class="nav-btn" onclick="switchTab('studio', this)">üìñ Studio</button>
        <button class="nav-btn" onclick="switchTab('grammatica', this)">üéì Grammatica</button>
        <button class="nav-btn" onclick="switchTab('scrittura', this)">‚úçÔ∏è Scrittura</button>
        <button class="nav-btn active" onclick="switchTab('quiz', this); openVocabQuiz()">Quiz Vocaboli</button>
        <button class="nav-btn" onclick="switchTab('ascolto', this)">Ascolto</button>
        <button class="nav-btn" onclick="switchTab('hiragana', this)">Hiragana</button>
        <button class="nav-btn" onclick="switchTab('katakana', this)">Katakana</button>
        <button class="nav-btn" onclick="switchTab('gestione', this)">Gestione</button>
    </nav>
    <div class="container">
        <div id="tab-studio" class="modulo-content hidden">
            <div class="card">
                <h2>Studia Vocaboli</h2>
                <p style="font-size:0.9rem; color:#666; text-align:center;">Giallo = Allungamenti e Raddoppi</p>
                <select id="filtro-studio" class="input-box" onchange="renderStudio()"><option value="TUTTI">Tutte le Categorie</option></select>
                <div id="lista-studio"></div>
            </div>
        </div>

        <div id="tab-grammatica" class="modulo-content hidden">
            <div class="card"><h2>Regole Grammaticali</h2><div id="lista-grammatica"></div></div>
        </div>
        
        <div id="tab-scrittura" class="modulo-content hidden">
            <div class="card">
                <div style="text-align:center; margin-bottom:15px; color:#888; font-weight:bold;" id="punteggio-write">Pronto</div>
                <div id="write-config">
                    <p style="text-align:center; color:#666; font-size:0.9rem;">Scegli categorie (anche multiple):</p>
                    
                    <div class="cat-controls">
                        <button class="btn btn-gray" onclick="toggleAllCats('scrittura', true)">Tutti</button>
                        <button class="btn btn-gray" onclick="toggleAllCats('scrittura', false)">Nessuno</button>
                    </div>
                    <div id="cat-grid-scrittura" class="cat-grid"></div>

                    <div class="deck-status" id="deck-status-write"></div>
                    <label class="mix-toggle" style="justify-content:center; margin-top:10px;"><input type="checkbox" id="write-mode-check"> Mostra Kana ‚Üí Scrivi Romaji</label>
                    <button class="btn btn-purple" style="margin-top:15px;" id="btn-start-write" onclick="startWriteSession()">Inizia Sessione</button>
                </div>
                <div id="write-area" class="hidden">
                    <div style="text-align:center; color:#aaa; font-size:0.85rem; font-weight:bold; letter-spacing:1px;" id="write-label">SCRIVI IL KANA</div>
                    <div id="prompt-scrittura">...</div>
                    <div id="sub-scrittura">...</div>
                    <div id="canvas-container"><canvas id="drawing-board"></canvas><div id="write-solution-overlay" class="soluzione-overlay hidden"></div></div>
                    <button id="btn-clear-canvas" class="btn btn-gray" style="margin-bottom:15px;" onclick="clearCanvas()">üßπ Cancella Disegno</button>
                    <input type="text" id="input-write" class="input-box" placeholder="Digita qui..." autocomplete="off">
                    <div id="feedback-write" class="feedback-box hidden"></div>
                    <div style="margin-top:15px; display:flex; gap:10px;">
                        <button id="btn-check-write" class="btn btn-blue" onclick="checkScrittura()">Controlla</button>
                        <button id="btn-next-write" class="btn btn-green hidden" onclick="nextWriteCard()">Prossima ‚Üí</button>
                    </div>
                    <div style="text-align:center; margin-top:20px;"><button class="btn btn-red" style="width:auto; font-size:0.8rem;" onclick="quitWriteSession()">Esci</button></div>
                </div>
                <div id="end-write-box" class="hidden" style="text-align:center; padding:20px;">
                    <h2 id="end-write-msg">Sessione Completata!</h2>
                    <p id="end-write-stat" style="font-size:1.1rem; color:#555; margin-bottom:20px;">...</p>
                    <button id="btn-write-ripasso" class="btn btn-orange hidden" onclick="avviaRipasso()">üîÅ Ripassa Errori</button>
                    <button class="btn btn-blue" id="btn-write-continue" onclick="startWriteSession()" style="margin-top:10px;">Nuova Sessione</button>
                </div>
            </div>
        </div>

        <div id="tab-quiz" class="modulo-content">
            <div class="card">
                <div style="text-align:center; margin-bottom:15px; color:#888; font-weight:bold;" id="punteggio">Pronto</div>
                
                <div id="quiz-start-screen" style="text-align:center;">
                     <p style="text-align:left; color:#666; font-size:0.9rem; margin-bottom:5px;">Seleziona Categorie:</p>
                     
                     <div class="cat-controls">
                        <button class="btn btn-gray" onclick="toggleAllCats('quiz', true)">Tutti</button>
                        <button class="btn btn-gray" onclick="toggleAllCats('quiz', false)">Nessuno</button>
                     </div>
                     <div id="cat-grid-quiz" class="cat-grid"></div>

                     <div class="deck-status" id="deck-status-quiz" style="margin-bottom:15px;"></div>

                     <label style="display:block; text-align:left; color:#666; font-size:0.9rem; margin-bottom:5px;">Modalit√†:</label>
                     <select id="quiz-mode-select" class="input-box" style="margin-bottom:15px;">
                        <option value="MIX">üîÄ Misto (Giapponese ‚Üî Italiano)</option>
                        <option value="J2I">üáØüáµ Giapponese ‚Üí üáÆüáπ Italiano</option>
                        <option value="I2J">üáÆüáπ Italiano ‚Üí üáØüáµ Giapponese</option>
                     </select>
                     <button class="btn btn-blue" id="btn-start-quiz" onclick="nuovaSessione()">Inizia Quiz</button>
                </div>

                <div id="quiz-area" class="hidden">
                    <div style="text-align:center; color:#aaa; font-size:0.85rem; font-weight:bold; letter-spacing:1px;" id="q-label">DOMANDA</div>
                    <div id="prompt-principale">...</div>
                    <div id="prompt-secondario">...</div>
                    <input type="text" id="input-risposta" class="input-box" placeholder="Scrivi qui..." autocomplete="off" autocapitalize="none">
                    <div id="choices-area" class="hidden"></div>
                    <div id="feedback" class="feedback-box hidden"></div>
                    <div id="controls-area" style="margin-top:15px;">
                        <button id="btn-check" class="btn btn-blue" onclick="controlla()">Controlla</button>
                        <button id="btn-next" class="btn btn-green hidden" onclick="prossima()">Prossima ‚Üí</button>
                    </div>
                </div>
                <div id="end-session-box" class="hidden" style="text-align:center; padding:20px;">
                    <h2 id="end-msg">Sessione Completata!</h2>
                    <p id="end-stat" style="font-size:1.1rem; color:#555; margin-bottom:20px;">...</p>
                    <button id="btn-ripasso" class="btn btn-orange hidden" onclick="avviaRipasso()">üîÅ Ripassa Errori</button>
                    <button id="btn-new-session" class="btn btn-blue" onclick="nuovaSessione()" style="margin-top:10px;">Prossima Sessione</button>
                </div>
                <div id="msg-no-data" class="hidden" style="text-align:center; padding:20px;">Caricamento dati...<br><button class="btn btn-blue" style="margin-top:10px; width:auto;" onclick="forceSync()">üîÑ Scarica Dati</button></div>
            </div>
        </div>
        <div id="tab-ascolto" class="modulo-content hidden"><div class="card"><h2>Dialoghi</h2><select id="filtro-frasi" class="input-box" onchange="renderFrasi()"><option value="TUTTI">Tutti</option></select><div style="text-align:center; margin-bottom:10px;"><input type="checkbox" id="spoiler-check" onchange="renderFrasi()"> Nascondi Ita</div><div id="lista-frasi"></div></div></div>
        <div id="tab-gestione" class="modulo-content hidden"><div class="card"><h2>Dati</h2><p>Vocaboli: <b id="count-v">0</b> | Frasi: <b id="count-f">0</b></p><button class="btn btn-blue" onclick="forceSync()">Aggiorna</button><button class="btn btn-red" style="margin-top:10px;" onclick="resetTotale()">Reset</button></div></div>
        <div id="tab-hiragana" class="modulo-content hidden"><div class="card"><h2>Hiragana</h2><div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:20px;"><label class="mix-toggle"><input type="checkbox" id="h-mix-mode"> üîÄ Modalit√† Mista</label><div class="config-grid" id="h-config"></div><button class="btn btn-green" onclick="startKanaQuiz('h')">AVVIA QUIZ</button></div><table class="kana-table" id="h-table"></table></div></div>
        <div id="tab-katakana" class="modulo-content hidden"><div class="card"><h2>Katakana</h2><div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:20px;"><label class="mix-toggle"><input type="checkbox" id="k-mix-mode"> üîÄ Modalit√† Mista</label><div class="config-grid" id="k-config"></div><button class="btn btn-green" onclick="startKanaQuiz('k')">AVVIA QUIZ</button></div><table class="kana-table" id="k-table"></table></div></div>
    </div>

    <script>
        const LINK_VOCABOLI = "https://raw.githubusercontent.com/cecifabrizio-beep/japan/refs/heads/main/importa.csv";
        const LINK_FRASI = "https://raw.githubusercontent.com/cecifabrizio-beep/japan/refs/heads/main/frasi.csv";
        const LINK_GRAMMATICA = "https://raw.githubusercontent.com/cecifabrizio-beep/flascard/refs/heads/main/grammatica2.csv";
        
        const RAW_HIRAGANA=[{k:'„ÅÇ',r:'a'},{k:'„ÅÑ',r:'i'},{k:'„ÅÜ',r:'u'},{k:'„Åà',r:'e'},{k:'„Åä',r:'o'},{k:'„Åã',r:'ka'},{k:'„Åç',r:'ki'},{k:'„Åè',r:'ku'},{k:'„Åë',r:'ke'},{k:'„Åì',r:'ko'},{k:'„Åï',r:'sa'},{k:'„Åó',r:'shi'},{k:'„Åô',r:'su'},{k:'„Åõ',r:'se'},{k:'„Åù',r:'so'},{k:'„Åü',r:'ta'},{k:'„Å°',r:'chi'},{k:'„Å§',r:'tsu'},{k:'„Å¶',r:'te'},{k:'„Å®',r:'to'},{k:'„Å™',r:'na'},{k:'„Å´',r:'ni'},{k:'„Å¨',r:'nu'},{k:'„Å≠',r:'ne'},{k:'„ÅÆ',r:'no'},{k:'„ÅØ',r:'ha'},{k:'„Å≤',r:'hi'},{k:'„Åµ',r:'fu'},{k:'„Å∏',r:'he'},{k:'„Åª',r:'ho'},{k:'„Åæ',r:'ma'},{k:'„Åø',r:'mi'},{k:'„ÇÄ',r:'mu'},{k:'„ÇÅ',r:'me'},{k:'„ÇÇ',r:'mo'},{k:'„ÇÑ',r:'ya'},{k:'„ÇÜ',r:'yu'},{k:'„Çà',r:'yo'},{k:'„Çâ',r:'ra'},{k:'„Çä',r:'ri'},{k:'„Çã',r:'ru'},{k:'„Çå',r:'re'},{k:'„Çç',r:'ro'},{k:'„Çè',r:'wa'},{k:'„Çí',r:'wo'},{k:'„Çì',r:'n'},{k:'„Åå',r:'ga'},{k:'„Åé',r:'gi'},{k:'„Åê',r:'gu'},{k:'„Åí',r:'ge'},{k:'„Åî',r:'go'},{k:'„Åñ',r:'za'},{k:'„Åò',r:'ji'},{k:'„Åö',r:'zu'},{k:'„Åú',r:'ze'},{k:'„Åû',r:'zo'},{k:'„Å†',r:'da'},{k:'„Å¢',r:'ji'},{k:'„Å•',r:'zu'},{k:'„Åß',r:'de'},{k:'„Å©',r:'do'},{k:'„Å∞',r:'ba'},{k:'„Å≥',r:'bi'},{k:'„Å∂',r:'bu'},{k:'„Åπ',r:'be'},{k:'„Åº',r:'bo'},{k:'„Å±',r:'pa'},{k:'„Å¥',r:'pi'},{k:'„Å∑',r:'pu'},{k:'„Å∫',r:'pe'},{k:'„ÅΩ',r:'po'},{k:'„Åç„ÇÉ',r:'kya'},{k:'„Åç„ÇÖ',r:'kyu'},{k:'„Åç„Çá',r:'kyo'},{k:'„Åó„ÇÉ',r:'sha'},{k:'„Åó„ÇÖ',r:'shu'},{k:'„Åó„Çá',r:'sho'},{k:'„Å°„ÇÉ',r:'cha'},{k:'„Å°„ÇÖ',r:'chu'},{k:'„Å°„Çá',r:'cho'},{k:'„Å´„ÇÉ',r:'nya'},{k:'„Å´„ÇÖ',r:'nyu'},{k:'„Å´„Çá',r:'nyo'},{k:'„Å≤„ÇÉ',r:'hya'},{k:'„Å≤„ÇÖ',r:'hyu'},{k:'„Å≤„Çá',r:'hyo'},{k:'„Åø„ÇÉ',r:'mya'},{k:'„Åø„ÇÖ',r:'myu'},{k:'„Åø„Çá',r:'myo'},{k:'„Çä„ÇÉ',r:'rya'},{k:'„Çä„ÇÖ',r:'ryu'},{k:'„Çä„Çá',r:'ryo'},{k:'„Åé„ÇÉ',r:'gya'},{k:'„Åé„ÇÖ',r:'gyu'},{k:'„Åé„Çá',r:'gyo'},{k:'„Åò„ÇÉ',r:'ja'},{k:'„Åò„ÇÖ',r:'ju'},{k:'„Åò„Çá',r:'jo'},{k:'„Å≥„ÇÉ',r:'bya'},{k:'„Å≥„ÇÖ',r:'byu'},{k:'„Å≥„Çá',r:'byo'},{k:'„Å¥„ÇÉ',r:'pya'},{k:'„Å¥„ÇÖ',r:'pyu'},{k:'„Å¥„Çá',r:'pyo'}];
        const RAW_KATAKANA=[{k:'„Ç¢',r:'a'},{k:'„Ç§',r:'i'},{k:'„Ç¶',r:'u'},{k:'„Ç®',r:'e'},{k:'„Ç™',r:'o'},{k:'„Ç´',r:'ka'},{k:'„Ç≠',r:'ki'},{k:'„ÇØ',r:'ku'},{k:'„Ç±',r:'ke'},{k:'„Ç≥',r:'ko'},{k:'„Çµ',r:'sa'},{k:'„Ç∑',r:'shi'},{k:'„Çπ',r:'su'},{k:'„Çª',r:'se'},{k:'„ÇΩ',r:'so'},{k:'„Çø',r:'ta'},{k:'„ÉÅ',r:'chi'},{k:'„ÉÑ',r:'tsu'},{k:'„ÉÜ',r:'te'},{k:'„Éà',r:'to'},{k:'„Éä',r:'na'},{k:'„Éã',r:'ni'},{k:'„Éå',r:'nu'},{k:'„Éç',r:'ne'},{k:'„Éé',r:'no'},{k:'„Éè',r:'ha'},{k:'„Éí',r:'hi'},{k:'„Éï',r:'fu'},{k:'„Éò',r:'he'},{k:'„Éõ',r:'ho'},{k:'„Éû',r:'ma'},{k:'„Éü',r:'mi'},{k:'„É†',r:'mu'},{k:'„É°',r:'me'},{k:'„É¢',r:'mo'},{k:'„É§',r:'ya'},{k:'„É¶',r:'yu'},{k:'„É®',r:'yo'},{k:'„É©',r:'ra'},{k:'„É™',r:'ri'},{k:'„É´',r:'ru'},{k:'„É¨',r:'re'},{k:'„É≠',r:'ro'},{k:'„ÉØ',r:'wa'},{k:'„É≤',r:'wo'},{k:'„É≥',r:'n'},{k:'„Ç¨',r:'ga'},{k:'„ÇÆ',r:'gi'},{k:'„Ç∞',r:'gu'},{k:'„Ç≤',r:'ge'},{k:'„Ç¥',r:'go'},{k:'„Ç∂',r:'za'},{k:'„Ç∏',r:'ji'},{k:'„Ç∫',r:'zu'},{k:'„Çº',r:'ze'},{k:'„Çæ',r:'zo'},{k:'„ÉÄ',r:'da'},{k:'„ÉÇ',r:'ji'},{k:'„ÉÖ',r:'zu'},{k:'„Éá',r:'de'},{k:'„Éâ',r:'do'},{k:'„Éê',r:'ba'},{k:'„Éì',r:'bi'},{k:'„Éñ',r:'bu'},{k:'„Éô',r:'be'},{k:'„Éú',r:'bo'},{k:'„Éë',r:'pa'},{k:'„Éî',r:'pi'},{k:'„Éó',r:'pu'},{k:'„Éö',r:'pe'},{k:'„Éù',r:'po'},{k:'„Ç≠„É£',r:'kya'},{k:'„Ç≠„É•',r:'kyu'},{k:'„Ç≠„Éß',r:'kyo'},{k:'„Ç∑„É£',r:'sha'},{k:'„Ç∑„É•',r:'shu'},{k:'„Ç∑„Éß',r:'sho'},{k:'„ÉÅ„É£',r:'cha'},{k:'„ÉÅ„É•',r:'chu'},{k:'„ÉÅ„Éß',r:'cho'},{k:'„Éã„É£',r:'nya'},{k:'„Éã„É•',r:'nyu'},{k:'„Éã„Éß',r:'nyo'},{k:'„Éí„É£',r:'hya'},{k:'„Éí„É•',r:'hyu'},{k:'„Éí„Éß',r:'hyo'},{k:'„Éü„É£',r:'mya'},{k:'„Éü„É•',r:'myu'},{k:'„Éü„Éß',r:'myo'},{k:'„É™„É£',r:'rya'},{k:'„É™„É•',r:'ryu'},{k:'„É™„Éß',r:'ryo'},{k:'„ÇÆ„É£',r:'gya'},{k:'„ÇÆ„É•',r:'gyu'},{k:'„ÇÆ„Éß',r:'gyo'},{k:'„Ç∏„É£',r:'ja'},{k:'„Ç∏„É•',r:'ju'},{k:'„Ç∏„Éß',r:'jo'},{k:'„Éì„É£',r:'bya'},{k:'„Éì„É•',r:'byu'},{k:'„Éì„Éß',r:'byo'},{k:'„Éî„É£',r:'pya'},{k:'„Éî„É•',r:'pyu'},{k:'„Éî„Éß',r:'pyo'}];
        const KANA_GROUPS = {'Vocali':[0,5],'K':[5,10],'S':[10,15],'T':[15,20],'N':[20,25],'H':[25,30],'M':[30,35],'Y':[35,38],'R':[38,43],'W/N':[43,46],'Dakuten':[46,71],'Yoon':[71,104]};

        let vocaboli = []; let frasi = []; let grammatica = []; let sessione = []; let errori = []; let card = null;
        let punteggio = { ok:0, err:0 }; let mode = 'vocab'; let mixMode = false; let activePool = [];
        let currentKanaPrefix = 'h'; 
        let writeSession = []; let canvas, ctx; let isDrawing = false;
        
        let activeDeckQuiz = []; 
        let activeDeckWrite = [];

        window.onload = function() {
            try {
                if(localStorage.getItem('srs_vocab_v40')) vocaboli = JSON.parse(localStorage.getItem('srs_vocab_v40'));
                if(localStorage.getItem('srs_frasi_v40')) frasi = JSON.parse(localStorage.getItem('srs_frasi_v40'));
                if(localStorage.getItem('srs_gramm_v40')) grammatica = JSON.parse(localStorage.getItem('srs_gramm_v40'));
            } catch(e) { localStorage.clear(); }
            
            aggiornaConta(); popolaFiltri(); renderTabelle('h', RAW_HIRAGANA); renderTabelle('k', RAW_KATAKANA); 
            renderFrasi(); renderStudio(); renderGrammatica();

            if(vocaboli.length === 0) forceSync();
            initCanvas();
            
            document.getElementById('input-risposta').addEventListener('keydown', function(e){ 
                if(e.key === 'Enter' && !this.classList.contains('hidden')) { 
                    e.preventDefault(); 
                    if(!document.getElementById('btn-check').classList.contains('hidden')) controlla(); 
                    else prossima(); 
                } 
            });
            document.getElementById('input-write').addEventListener('keydown', function(e){ 
                if(e.key === 'Enter') {
                    e.preventDefault();
                    if(!document.getElementById('btn-check-write').classList.contains('hidden')) checkScrittura();
                    else nextWriteCard();
                }
            });
            
            // Non resetto subito il deck perch√® ora dipende dalla selezione manuale
            updateDeckStatus('quiz');
            updateDeckStatus('scrittura');
        };

        function showNotification(msg, type) { const el = document.getElementById('sync-status'); el.className = type; el.innerText = msg; el.style.display = 'block'; setTimeout(() => { el.style.display = 'none'; }, 4000); }
        function forceSync() {
            showNotification("Download dati in corso...", "sync-loading");
            const ts = new Date().getTime();
            Promise.all([
                fetch(LINK_VOCABOLI + "?t=" + ts).then(r => r.ok ? r.text() : Promise.reject('Err Vocab')), 
                fetch(LINK_FRASI + "?t=" + ts).then(r => r.ok ? r.text() : Promise.reject('Err Frasi')),
                fetch(LINK_GRAMMATICA + "?t=" + ts).then(r => r.ok ? r.text() : Promise.resolve("")) 
            ])
            .then(([txtV, txtF, txtG]) => {
                const countV = parseCSV(txtV, 'vocab', false);
                const countF = parseCSV(txtF, 'frasi', false);
                const countG = parseCSV(txtG, 'grammatica', false);
                showNotification(`Aggiornato! V:${countV} F:${countF} G:${countG}`, "sync-success");
                aggiornaConta(); popolaFiltri(); renderFrasi(); renderStudio(); renderGrammatica();
                if(vocaboli.length > 0) openVocabQuiz(); 
            }).catch(e => { console.error(e); showNotification("Errore Scaricamento Dati", "sync-error"); });
        }

        function switchTab(id, btnElement) {
            document.querySelectorAll('.modulo-content').forEach(d => d.classList.add('hidden'));
            document.getElementById('tab-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
            else { const navBtn = document.querySelector(`button[onclick*="'${id}'"]`); if(navBtn) navBtn.classList.add('active'); }
        }

        // --- GESTIONE MULTI-CATEGORIA ---
        function popolaFiltri() {
            const tags = new Set(vocaboli.map(v => v.tag));
            const sortedTags = Array.from(tags).sort();
            
            // Studio Tab (rimane Select semplice)
            const sStudio = document.getElementById('filtro-studio');
            sStudio.innerHTML = '<option value="TUTTI">Tutte le Categorie</option>';
            sortedTags.forEach(t => sStudio.innerHTML += `<option value="${t}">${t}</option>`);

            // Quiz & Scrittura (Multi-Select)
            createMultiSelect('cat-grid-quiz', sortedTags, 'quiz');
            createMultiSelect('cat-grid-scrittura', sortedTags, 'scrittura');

            const f = document.getElementById('filtro-frasi'); f.innerHTML = '<option value="TUTTI">Tutti i Dialoghi</option>';
            const fTags = new Set(frasi.map(v => v.tag)); fTags.forEach(t => f.innerHTML += `<option value="${t}">${t}</option>`);
        }

        function createMultiSelect(containerId, tags, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            tags.forEach(t => {
                const div = document.createElement('div');
                div.className = 'cat-option selected'; // Default selected
                div.innerText = t;
                div.dataset.value = t;
                div.onclick = function() {
                    this.classList.toggle('selected');
                    resetDeck(type);
                };
                container.appendChild(div);
            });
        }

        function toggleAllCats(type, state) {
            const id = type === 'quiz' ? 'cat-grid-quiz' : 'cat-grid-scrittura';
            document.querySelectorAll(`#${id} .cat-option`).forEach(el => {
                if(state) el.classList.add('selected');
                else el.classList.remove('selected');
            });
            resetDeck(type);
        }

        function getSelectedTags(type) {
            const id = type === 'quiz' ? 'cat-grid-quiz' : 'cat-grid-scrittura';
            const els = document.querySelectorAll(`#${id} .cat-option.selected`);
            return Array.from(els).map(el => el.dataset.value);
        }

        function resetDeck(type) {
            let statusId = (type === 'quiz') ? 'deck-status-quiz' : 'deck-status-write';
            let selected = getSelectedTags(type);
            
            let deck = vocaboli.filter(v => selected.includes(v.tag));
            deck = deck.sort(() => 0.5 - Math.random());
            
            if(type === 'quiz') activeDeckQuiz = deck;
            else activeDeckWrite = deck;

            let el = document.getElementById(statusId);
            if(deck.length > 0) el.innerHTML = `Parole nel mazzo: <span class="deck-badge">${deck.length}</span>`;
            else el.innerHTML = `<span style="color:#dc3545">Nessuna categoria selezionata!</span>`;
        }

        function updateDeckStatus(type) {
            resetDeck(type); // Ricalcola e aggiorna
        }

        // --- FORMATTAZIONE E LOGICA ---
        function formatRomaji(text) { return text.replace(/([a-z])\1|ei|ou/gi, '<span class="hlt">$&</span>'); }
        function formatKana(text) {
            let out = text.replace(/([„ÉÉ„Å£„Éº])/g, '<span class="hlt">$1</span>');
            out = out.replace(/([„Åä„Åì„Åù„Å®„ÅÆ„Åª„ÇÇ„Çà„Çç„Çí„Åî„Åû„Å©„Åº„ÅΩ])(„ÅÜ)/g, '$1<span class="hlt">$2</span>');
            out = out.replace(/([„Åà„Åë„Åõ„Å¶„Å≠„Å∏„ÇÅ„Çå„Åí„Åú„Åß„Åπ„Å∫])(„ÅÑ)/g, '$1<span class="hlt">$2</span>');
            return out;
        }
        function cleanText(text) { return text.toLowerCase().replace(/[.,?Ôºü„ÄÇ„ÄÅ!ÔºÅ]/g, '').replace(/oo/g, 'ou').replace(/ee/g, 'ei').trim(); }

        function initCanvas() {
            canvas = document.getElementById('drawing-board'); ctx = canvas.getContext('2d'); canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.strokeStyle = '#000';
            canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', stopDraw); canvas.addEventListener('mouseout', stopDraw);
            canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDraw(e.touches[0]); }); canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); }); canvas.addEventListener('touchend', stopDraw);
        }
        function startDraw(e) { isDrawing = true; const rect = canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top); }
        function draw(e) { if(!isDrawing) return; const rect = canvas.getBoundingClientRect(); ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top); ctx.stroke(); }
        function stopDraw() { isDrawing = false; }
        function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

        function startWriteSession() {
            mode = 'scrittura';
            resetDeck('scrittura'); // Assicura che il deck sia fresco
            if(activeDeckWrite.length === 0) { alert("Seleziona almeno una categoria!"); return; }
            
            let n = Math.min(10, activeDeckWrite.length);
            writeSession = activeDeckWrite.splice(0, n);
            updateDeckStatus('scrittura');
            document.getElementById('write-config').classList.add('hidden'); document.getElementById('write-area').classList.remove('hidden'); document.getElementById('end-write-box').classList.add('hidden'); 
            errori = []; punteggio = {ok:0, err:0}; nextWriteCard();
        }

        function nextWriteCard() {
            if(writeSession.length === 0) { endScritturaSession(); return; }
            card = writeSession.pop(); const rev = document.getElementById('write-mode-check').checked;
            clearCanvas(); const input = document.getElementById('input-write'); input.value = ''; input.readOnly = false; input.disabled = false;
            document.getElementById('feedback-write').classList.add('hidden'); document.getElementById('feedback-write').classList.remove('fb-corretto', 'fb-sbagliato');
            document.getElementById('write-solution-overlay').classList.add('hidden'); document.getElementById('write-solution-overlay').classList.remove('soluzione-visibile');
            document.getElementById('btn-check-write').classList.remove('hidden'); document.getElementById('btn-next-write').classList.add('hidden');
            document.getElementById('punteggio-write').innerText = `Corretti: ${punteggio.ok} | Errori: ${punteggio.err}`;
            const label = document.getElementById('prompt-scrittura'); const sub = document.getElementById('sub-scrittura'); sub.innerText = `(${card.ita})`; 
            if(!rev) { label.innerHTML = formatRomaji(card.rom); document.getElementById('write-label').innerText = "SCRIVI IL GIAPPONESE"; document.getElementById('canvas-container').classList.remove('hidden'); document.getElementById('btn-clear-canvas').classList.remove('hidden'); } 
            else { label.innerHTML = formatKana(card.jpn); document.getElementById('write-label').innerText = "SCRIVI IL ROMAJI"; document.getElementById('canvas-container').classList.add('hidden'); document.getElementById('btn-clear-canvas').classList.add('hidden'); }
            setTimeout(() => input.focus(), 50);
        }

        function checkScrittura() {
            const input = document.getElementById('input-write'); const val = cleanText(input.value); const feed = document.getElementById('feedback-write'); const overlay = document.getElementById('write-solution-overlay'); const rev = document.getElementById('write-mode-check').checked; 
            let ok = false; let target = ""; if(!rev) { target = card.jpn; if(val === cleanText(card.jpn)) ok = true; } else { target = card.rom; if(val === cleanText(card.rom) || val === cleanText(card.ita)) ok = true; }
            feed.classList.remove('hidden', 'fb-corretto', 'fb-sbagliato'); const jpnSafe = card.jpn.replace(/'/g, "\\'"); const audioBtn = ` <span style="cursor:pointer; font-size:1.2rem" onclick="parla('${jpnSafe}')">üîä</span>`; let solDisplay = (!rev) ? formatKana(card.jpn) : formatRomaji(card.rom);
            if(input.value.trim() === "") { punteggio.err++; errori.push(card); feed.classList.add('fb-sbagliato'); feed.innerHTML = `Soluzione: <b>${solDisplay}</b>` + audioBtn; if(!rev) { overlay.innerText = card.jpn; overlay.classList.remove('hidden'); overlay.classList.add('soluzione-visibile'); } } 
            else { if(ok) { punteggio.ok++; feed.classList.add('fb-corretto'); feed.innerHTML = "‚úÖ Esatto!" + audioBtn; } else { punteggio.err++; errori.push(card); feed.classList.add('fb-sbagliato'); feed.innerHTML = `‚ùå Errato! Era: <b>${solDisplay}</b>` + audioBtn; if(!rev) { overlay.innerText = card.jpn; overlay.classList.remove('hidden'); overlay.classList.add('soluzione-visibile'); } } }
            input.readOnly = true; document.getElementById('btn-check-write').classList.add('hidden'); document.getElementById('btn-next-write').classList.remove('hidden'); document.getElementById('punteggio-write').innerText = `Corretti: ${punteggio.ok} | Errori: ${punteggio.err}`;
        }

        function endScritturaSession() {
            document.getElementById('write-area').classList.add('hidden'); document.getElementById('end-write-box').classList.remove('hidden');
            document.getElementById('end-write-msg').innerText = "Sessione Completata"; document.getElementById('end-write-stat').innerText = `Punteggio: ${punteggio.ok} giuste, ${punteggio.err} errori.`;
            const btnRip = document.getElementById('btn-write-ripasso'); if(errori.length > 0) { btnRip.classList.remove('hidden'); btnRip.innerText = `üîÅ Ripassa ${errori.length} Errori`; } else { btnRip.classList.add('hidden'); }
            const btnCont = document.getElementById('btn-write-continue'); btnCont.innerText = "Nuova Sessione"; btnCont.onclick = function() { startWriteSession(); } 
        }

        function quitWriteSession() { document.getElementById('write-area').classList.add('hidden'); document.getElementById('write-config').classList.remove('hidden'); updateDeckStatus('scrittura'); }

        function renderStudio() {
            const div = document.getElementById('lista-studio'); const filter = document.getElementById('filtro-studio').value; div.innerHTML = '';
            const list = (filter === 'TUTTI') ? vocaboli : vocaboli.filter(v => v.tag === filter);
            if(list.length === 0) { div.innerHTML = '<p style="text-align:center; padding:20px;">Nessun vocabolo.</p>'; return; }
            div.innerHTML = list.map(v => { const jpnSafe = v.jpn.replace(/'/g,"\\'"); return `<div class="list-entry"><button class="play-btn" onclick="parla('${jpnSafe}')">‚ñ∂</button><div class="list-text"><span class="txt-jpn">${formatKana(v.jpn)}</span><span class="txt-rom">${formatRomaji(v.rom)}</span><span class="txt-ita">${v.ita}</span></div></div>`; }).join('');
        }

        function renderGrammatica() {
            const div = document.getElementById('lista-grammatica'); div.innerHTML = '';
            if(grammatica.length === 0) { div.innerHTML = '<p style="text-align:center; padding:20px;">Nessuna regola caricata.</p>'; return; }
            
            grammatica.forEach((g, idx) => {
                const jpnSafe = g.es_jpn.replace(/'/g,"\\'");
                const html = `<div class="gram-item"><div class="gram-header" onclick="toggleAccordion('g-${idx}')"><span>${g.titolo}</span><span style="color:#007aff">‚ñº</span></div><div id="g-${idx}" class="gram-content"><p>${g.spiegazione}</p><div class="gram-example"><span class="gram-ex-jp">${g.es_jpn} <span style="cursor:pointer" onclick="parla('${jpnSafe}')">üîä</span></span><span class="gram-ex-rom">${g.es_rom}</span><span class="gram-ex-it">${g.es_ita}</span></div></div></div>`;
                div.innerHTML += html;
            });
        }

        function toggleAccordion(id) { const el = document.getElementById(id); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }

        function openVocabQuiz() { 
            mode = 'vocab'; document.getElementById('quiz-start-screen').classList.remove('hidden'); 
            document.getElementById('quiz-area').classList.add('hidden'); document.getElementById('end-session-box').classList.add('hidden'); updateDeckStatus('quiz');
        }

        function nuovaSessione() {
            if(mode === 'kana') { document.getElementById('end-session-box').classList.add('hidden'); document.getElementById('quiz-area').classList.remove('hidden'); errori = []; punteggio = { ok:0, err:0 }; prossima(); return; }
            
            resetDeck('quiz'); // Refresh selection
            if(activeDeckQuiz.length === 0) { alert("Seleziona almeno una categoria!"); return; }
            
            document.getElementById('quiz-start-screen').classList.add('hidden'); document.getElementById('end-session-box').classList.add('hidden'); document.getElementById('quiz-area').classList.remove('hidden');
            let n = Math.min(10, activeDeckQuiz.length); sessione = activeDeckQuiz.splice(0, n); updateDeckStatus('quiz');
            errori = []; punteggio = { ok:0, err:0 }; prossima();
        }

        function avviaRipasso() {
            if(mode === 'scrittura') { writeSession = [...errori]; errori = []; document.getElementById('end-write-box').classList.add('hidden'); document.getElementById('write-area').classList.remove('hidden'); nextWriteCard(); }
            else { sessione = [...errori]; errori = []; document.getElementById('end-session-box').classList.add('hidden'); document.getElementById('quiz-area').classList.remove('hidden'); prossima(); }
        }

        function prossima() {
            if(sessione.length === 0) { concludiSessione(); return; }
            card = sessione.pop(); const input = document.getElementById('input-risposta'); const choicesDiv = document.getElementById('choices-area'); const feed = document.getElementById('feedback'); const btnCheck = document.getElementById('btn-check'); const btnNext = document.getElementById('btn-next');
            feed.classList.add('hidden'); feed.classList.remove('fb-corretto', 'fb-sbagliato'); btnNext.classList.add('hidden'); document.getElementById('punteggio').innerText = `Corretti: ${punteggio.ok} | Errori: ${punteggio.err}`;
            let showInput = true;
            if(mode === 'vocab') {
                const modeSel = document.getElementById('quiz-mode-select').value;
                let dir = 'j2i';
                if(modeSel === 'MIX') dir = Math.random() > 0.5 ? 'j2i' : 'i2j';
                else if(modeSel === 'J2I') dir = 'j2i';
                else dir = 'i2j';
                
                card.dir = dir;
                
                if(dir === 'j2i') { 
                    document.getElementById('q-label').innerText = "TRADUCI IN ITALIANO"; 
                    document.getElementById('prompt-principale').innerHTML = `${formatKana(card.jpn)} <span style="font-size:1.5rem; cursor:pointer;" onclick="parla('${card.jpn.replace(/'/g,"\\'")} ')">üîä</span>`; 
                    document.getElementById('prompt-secondario').innerHTML = formatRomaji(card.rom); 
                }
                else { 
                    document.getElementById('q-label').innerText = "TRADUCI IN GIAPPONESE (ROMAJI)"; 
                    document.getElementById('prompt-principale').innerText = card.ita; 
                    document.getElementById('prompt-secondario').innerText = card.eng || ""; 
                }
            } else {
                let dir = 'k2r'; if(mixMode && Math.random() > 0.5) dir = 'r2k'; card.dir = dir;
                if(dir === 'k2r') { document.getElementById('q-label').innerText = "SCRIVI IL ROMAJI"; document.getElementById('prompt-principale').innerText = card.k; document.getElementById('prompt-secondario').innerText = ""; }
                else { document.getElementById('q-label').innerText = "SELEZIONA IL KANA"; document.getElementById('prompt-principale').innerText = card.r; document.getElementById('prompt-secondario').innerText = ""; showInput = false; generaScelte(card); }
            }
            if(showInput) { input.value = ''; input.readOnly = false; input.disabled = false; input.classList.remove('hidden'); choicesDiv.classList.add('hidden'); btnCheck.classList.remove('hidden'); setTimeout(() => input.focus(), 50); }
            else { input.classList.add('hidden'); choicesDiv.classList.remove('hidden'); btnCheck.classList.add('hidden'); }
        }

        function concludiSessione() {
            document.getElementById('quiz-area').classList.add('hidden'); document.getElementById('end-session-box').classList.remove('hidden');
            let msg = "Sessione Completata"; document.getElementById('end-msg').innerText = msg; document.getElementById('end-stat').innerText = `Punteggio: ${punteggio.ok} giuste, ${punteggio.err} errori.`;
            const btnRip = document.getElementById('btn-ripasso'); if(errori.length > 0) { btnRip.classList.remove('hidden'); btnRip.innerText = `üîÅ Ripassa ${errori.length} Errori`; } else { btnRip.classList.add('hidden'); }
            const btnNew = document.getElementById('btn-new-session');
            if(mode === 'vocab') { btnNew.innerText = "Nuova Sessione"; btnNew.onclick = function() { nuovaSessione(); } }
            else { const label = (currentKanaPrefix === 'h') ? "Hiragana" : "Katakana"; btnNew.innerText = `Torna a ${label}`; btnNew.onclick = function() { switchTab(currentKanaPrefix === 'h' ? 'hiragana' : 'katakana'); }; }
        }

        function generaScelte(corretta) {
            const div = document.getElementById('choices-area'); div.innerHTML = '';
            let pool = activePool.filter(x => x.k !== corretta.k);
            if(pool.length < 3) { pool = (mode==='kana' && corretta.k.match(/[„ÅÇ-„Çì]/)) ? RAW_HIRAGANA : RAW_KATAKANA; pool = pool.filter(x => x.k !== corretta.k); }
            let options = pool.sort(() => 0.5 - Math.random()).slice(0, 3); options.push(corretta); options.sort(() => 0.5 - Math.random()); 
            options.forEach(opt => { const btn = document.createElement('button'); btn.className = 'choice-btn'; btn.innerText = opt.k; btn.onclick = () => verificaScelta(opt, corretta, btn); div.appendChild(btn); });
        }

        function verificaScelta(selezionata, corretta, btnElement) {
            const btns = document.querySelectorAll('.choice-btn'); btns.forEach(b => b.disabled = true); const feed = document.getElementById('feedback'); feed.classList.remove('hidden', 'fb-corretto', 'fb-sbagliato');
            if(selezionata.k === corretta.k) { punteggio.ok++; btnElement.classList.add('btn-correct'); feed.classList.add('fb-corretto'); feed.innerText = "‚úÖ Esatto!"; }
            else { punteggio.err++; errori.push(card); btnElement.classList.add('btn-wrong'); feed.classList.add('fb-sbagliato'); feed.innerHTML = `‚ùå Sbagliato! Era: <b>${corretta.k}</b>`; btns.forEach(b => { if(b.innerText === corretta.k) b.classList.add('btn-correct'); }); }
            document.getElementById('btn-next').classList.remove('hidden'); document.getElementById('btn-next').focus();
        }

        function controlla() {
            const input = document.getElementById('input-risposta'); const feed = document.getElementById('feedback'); const user = cleanText(input.value); let ok = false; let ans = "";
            if(mode === 'vocab') {
                if(card.dir === 'j2i') { if(user == cleanText(card.ita) || (card.eng && user == cleanText(card.eng))) ok = true; ans = card.ita; }
                else { if(user == cleanText(card.rom) || user == cleanText(card.jpn)) ok = true; ans = `${formatRomaji(card.rom)} (${card.jpn})`; }
            } else { if(user == cleanText(card.r)) ok = true; ans = card.r; }
            feed.classList.remove('hidden', 'fb-corretto', 'fb-sbagliato'); const jpnSafe = (mode === 'vocab') ? card.jpn.replace(/'/g, "\\'") : ''; const audioBtn = (mode === 'vocab') ? ` <span style="cursor:pointer; font-size:1.2rem" onclick="parla('${jpnSafe}')">üîä</span>` : '';
            if(ok) { punteggio.ok++; feed.classList.add('fb-corretto'); feed.innerHTML = "‚úÖ Esatto!" + audioBtn; } else { punteggio.err++; errori.push(card); feed.classList.add('fb-sbagliato'); feed.innerHTML = `‚ùå Sbagliato! Era: <b>${ans}</b>` + audioBtn; }
            input.readOnly = true; document.getElementById('btn-check').classList.add('hidden'); document.getElementById('btn-next').classList.remove('hidden'); 
        }

        function renderTabelle(prefix, data) { const t = document.getElementById(prefix+'-table'); let html = '<tr>'; for(let i=0; i<data.length; i++) { html += `<td><span class="kc">${data[i].k}</span><span class="kr">${data[i].r}</span></td>`; if((i+1)%5 === 0) html += '</tr><tr>'; } t.innerHTML = html; const conf = document.getElementById(prefix+'-config'); let chkHtml = ''; Object.keys(KANA_GROUPS).forEach(key => { chkHtml += `<label class="checkbox-label"><input type="checkbox" value="${key}" checked> ${key}</label>`; }); conf.innerHTML = chkHtml; }
        function toggleKana(prefix, state) { document.querySelectorAll(`#${prefix}-config input`).forEach(c => c.checked = state); }
        function startKanaQuiz(prefix) { currentKanaPrefix = prefix; const dataset = (prefix==='h') ? RAW_HIRAGANA : RAW_KATAKANA; const checkboxes = document.querySelectorAll(`#${prefix}-config input:checked`); const mixCheck = document.getElementById(prefix + '-mix-mode'); mixMode = mixCheck.checked; let pool = []; checkboxes.forEach(chk => { const range = KANA_GROUPS[chk.value]; if(range) pool = pool.concat(dataset.slice(range[0], range[1])); }); if(pool.length === 0) { alert("Seleziona almeno una riga"); return; } activePool = pool; sessione = pool.sort(() => 0.5 - Math.random()); mode = 'kana'; switchTab('quiz', document.querySelector(`button[onclick*="switchTab('${prefix==='h'?'hiragana':'katakana'}"]`)); document.getElementById('quiz-start-screen').classList.add('hidden'); document.getElementById('end-session-box').classList.add('hidden'); document.getElementById('quiz-area').classList.remove('hidden'); nuovaSessione(); }
        
        function parseCSV(text, type, reload) { 
            if(!text) return 0;
            const lines = text.trim().split('\n'); let count = 0; 
            if(type === 'vocab') { 
                vocaboli = []; lines.forEach(l => { const sep = l.includes('|') ? '|' : ','; const p = l.split(sep); if(p.length >= 4) { vocaboli.push({ita:p[0].trim(), eng:p[1].trim(), jpn:p[2].trim(), rom:p[3].trim(), tag:p[4]?p[4].trim():'Gen'}); count++; } }); 
                localStorage.setItem('srs_vocab_v40', JSON.stringify(vocaboli)); 
            } else if(type === 'frasi') { 
                frasi = []; lines.forEach(l => { const sep = l.includes('|') ? '|' : ','; const p = l.split(sep); if(p.length >= 3) { frasi.push({ita:p[0].trim(), rom:p[1].trim(), jpn:p[2].trim(), tag:p[3]?p[3].trim():'Gen'}); count++; } }); 
                localStorage.setItem('srs_frasi_v40', JSON.stringify(frasi)); 
            } else if(type === 'grammatica') {
                grammatica = []; lines.forEach(l => { const sep = l.includes('|') ? '|' : ','; const p = l.split(sep); if(p.length >= 5) { grammatica.push({titolo:p[0].trim(), spiegazione:p[1].trim(), es_jpn:p[2].trim(), es_rom:p[3].trim(), es_ita:p[4].trim(), tag:p[5]?p[5].trim():'Gen'}); count++; } });
                localStorage.setItem('srs_gramm_v40', JSON.stringify(grammatica));
            }
            if(reload) location.reload(); return count; 
        }
        function resetTotale() { if(confirm("Sicuro di voler cancellare tutti i dati salvati?")) { localStorage.clear(); location.reload(); } }
        function aggiornaConta() { document.getElementById('count-v').innerText = vocaboli.length; document.getElementById('count-f').innerText = frasi.length; document.getElementById('count-g').innerText = grammatica.length; }
        function renderFrasi() { const div = document.getElementById('lista-frasi'); const spoiler = document.getElementById('spoiler-check').checked; const filter = document.getElementById('filtro-frasi').value; div.innerHTML = ''; const list = (filter === 'TUTTI') ? frasi : frasi.filter(f => f.tag === filter); if(list.length === 0) { div.innerHTML = '<p style="text-align:center">Nessuna frase</p>'; return; } div.innerHTML = list.map(f => { const jpnSafe = f.jpn.replace(/'/g,"\\'"); return `<div class="list-entry ${spoiler?'spoiler':''}"><button class="play-btn" onclick="parla('${jpnSafe}')">‚ñ∂</button><div class="list-text"><span class="txt-jpn">${formatKana(f.jpn)}</span><span class="txt-rom">${formatRomaji(f.rom)}</span><span class="txt-ita">${f.ita}</span></div></div>`; }).join(''); }
        function parla(t) { if ('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(t); u.lang = 'ja-JP'; u.rate = 0.9; window.speechSynthesis.speak(u); } else { alert("Il tuo browser non supporta la sintesi vocale."); } }
    </script>
</body>
</html>
