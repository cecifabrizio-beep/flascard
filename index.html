<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giapponese SRS v19.0 (Smart Nav)</title>
    <style>
        /* --- STILE GENERALE --- */
        body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        h1 { color: #1c1c1e; margin-bottom: 20px; text-align: center; font-size: 1.8rem; }
        .container { width: 100%; max-width: 600px; margin-bottom: 50px; }
        .card { background: #ffffff; padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .hidden { display: none !important; }

        /* --- NOTIFICHE --- */
        #sync-status {
            position: fixed; top: 10px; right: 10px; padding: 10px 15px; border-radius: 20px; 
            font-size: 0.8rem; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: none; z-index: 1000;
        }
        .sync-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .sync-loading { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .sync-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* --- MENU --- */
        #main-nav { display: flex; gap: 8px; width: 100%; max-width: 600px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
        .nav-btn { flex: 1; padding: 12px; border: none; border-radius: 25px; background-color: #fff; color: #555; font-weight: 600; cursor: pointer; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s; }
        .nav-btn.active { background-color: #007aff; color: white; box-shadow: 0 4px 8px rgba(0,122,255,0.3); }

        /* --- UI INPUT & FEEDBACK --- */
        .input-box { width: 100%; padding: 12px; font-size: 1.1rem; border: 2px solid #ddd; border-radius: 12px; box-sizing: border-box; margin-bottom: 10px; text-align: center; transition: all 0.3s; }
        .input-box:focus { border-color: #007aff; outline: none; }
        
        .feedback-box { text-align: center; font-weight: bold; font-size: 1.2rem; padding: 15px; border-radius: 12px; margin: 15px 0; border: 2px solid transparent; }
        .fb-corretto { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .fb-sbagliato { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }

        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; color: white; margin-top: 5px; transition: 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-blue { background-color: #007aff; } 
        .btn-green { background-color: #28a745; } 
        .btn-orange { background-color: #fd7e14; }
        .btn-red { background-color: #dc3545; }

        /* --- SCELTA MULTIPLA --- */
        #choices-area { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .choice-btn {
            background: #f8f9fa; border: 2px solid #e9ecef; padding: 20px;
            font-size: 2rem; border-radius: 16px; cursor: pointer; transition: 0.2s;
            font-weight: bold; color: #333; display: flex; justify-content: center; align-items: center;
        }
        .choice-btn:hover { background: #e2e6ea; border-color: #adb5bd; }
        .btn-correct { background-color: #d4edda !important; border-color: #28a745 !important; color: #155724 !important; }
        .btn-wrong { background-color: #f8d7da !important; border-color: #dc3545 !important; color: #721c24 !important; opacity: 0.6; }

        /* --- QUIZ LAYOUT --- */
        #prompt-principale { font-size: 3rem; margin: 10px 0; text-align: center; font-weight: 500; min-height: 60px; word-break: keep-all; }
        #prompt-secondario { font-size: 1.1rem; color: #666; text-align: center; margin-bottom: 20px; min-height: 20px; }

        /* --- ASCOLTO & STUDIO LAYOUT --- */
        .list-entry { display: flex; align-items: flex-start; background: #ffffff; border-bottom: 1px solid #eee; padding: 15px 10px; gap: 15px; }
        .play-btn { width: 48px; height: 48px; border-radius: 50%; background: #007aff; color: white; border: none; font-size: 1.2rem; cursor: pointer; flex-shrink: 0; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 6px rgba(0,122,255,0.2); }
        .play-btn:active { transform: scale(0.95); }
        .list-text { flex-grow: 1; }
        
        .txt-jpn { font-weight: bold; font-size: 1.25rem; display: block; color: #333; margin-bottom: 4px; line-height: 1.4; }
        .txt-rom { font-size: 0.9rem; color: #888; display: block; margin-bottom: 6px; }
        .txt-ita { color: #007aff; font-size: 1rem; font-weight: 500; display: block; cursor: pointer; background: #f0f8ff; padding: 5px 8px; border-radius: 6px; display: inline-block; }
        
        .spoiler .txt-ita { background: #e0e0e0; color: transparent; user-select: none; }
        .spoiler .txt-ita:hover { background: #f0f8ff; color: #007aff; cursor: help; }

        /* --- KANA --- */
        .kana-table { width: 100%; border-collapse: collapse; text-align: center; margin-bottom: 20px; }
        .kana-table th { background: #f2f2f7; padding: 8px; font-size: 0.9rem; color: #666; }
        .kana-table td { border: 1px solid #eee; padding: 8px; font-size: 1.1rem; }
        .kc { font-weight: bold; display: block; color: #222; }
        .kr { font-size: 0.75rem; color: #999; }
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .checkbox-label { background: white; padding: 8px; border-radius: 8px; border: 1px solid #eee; display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .mix-toggle { background: #e7f3ff; border: 1px solid #007aff; color: #007aff; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-weight: bold; display: flex; align-items: center; gap: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="sync-status"></div>
    <h1>Set di Studio Giapponese</h1>

    <nav id="main-nav">
        <button class="nav-btn" onclick="switchTab('studio', this)">üìñ Studio</button>
        <button class="nav-btn active" onclick="switchTab('quiz', this); openVocabQuiz()">Quiz Vocaboli</button>
        <button class="nav-btn" onclick="switchTab('ascolto', this)">Ascolto</button>
        <button class="nav-btn" onclick="switchTab('hiragana', this)">Hiragana</button>
        <button class="nav-btn" onclick="switchTab('katakana', this)">Katakana</button>
        <button class="nav-btn" onclick="switchTab('gestione', this)">Gestione</button>
    </nav>

    <div class="container">

        <div id="tab-studio" class="modulo-content hidden">
            <div class="card">
                <h2>Studia Vocaboli</h2>
                <p style="font-size:0.9rem; color:#666; text-align:center;">Seleziona un argomento per leggere e ascoltare.</p>
                <select id="filtro-studio" class="input-box" onchange="renderStudio()">
                    <option value="TUTTI">Tutte le Categorie</option>
                </select>
                <div id="lista-studio"></div>
            </div>
        </div>

        <div id="tab-quiz" class="modulo-content">
            <div class="card">
                <div style="text-align:center; margin-bottom:15px; color:#888; font-weight:bold;" id="punteggio">Pronto</div>
                
                <select id="filtro-cat" class="input-box" onchange="openVocabQuiz()"><option value="TUTTI">Tutte le Categorie</option></select>
                
                <div id="quiz-area">
                    <div style="text-align:center; color:#aaa; font-size:0.85rem; font-weight:bold; letter-spacing:1px;" id="q-label">DOMANDA</div>
                    <div id="prompt-principale">...</div>
                    <div id="prompt-secondario">...</div>
                    
                    <input type="text" id="input-risposta" class="input-box" placeholder="Scrivi qui..." autocomplete="off" autocapitalize="none">
                    <div id="choices-area" class="hidden"></div>
                    <div id="feedback" class="feedback-box hidden"></div>

                    <div id="controls-area" style="margin-top:15px;">
                        <button id="btn-check" class="btn btn-blue" onclick="controlla()">Controlla</button>
                        <button id="btn-next" class="btn btn-green hidden" onclick="prossima()">Prossima ‚Üí</button>
                    </div>
                </div>

                <div id="end-session-box" class="hidden" style="text-align:center; padding:20px;">
                    <h2 id="end-msg">Sessione Completata!</h2>
                    <p id="end-stat" style="font-size:1.1rem; color:#555; margin-bottom:20px;">...</p>
                    <button id="btn-ripasso" class="btn btn-orange hidden" onclick="avviaRipasso()">üîÅ Ripassa Errori</button>
                    
                    <button id="btn-new-session" class="btn btn-blue" onclick="openVocabQuiz()" style="margin-top:10px;">Nuova Sessione</button>
                </div>

                <div id="msg-no-data" class="hidden" style="text-align:center; padding:20px;">
                    Caricamento dati in corso o nessun dato presente...<br>
                    <button class="btn btn-blue" style="margin-top:10px; width:auto;" onclick="forceSync()">üîÑ Scarica Dati</button>
                </div>
            </div>
        </div>

        <div id="tab-ascolto" class="modulo-content hidden">
            <div class="card">
                <h2 style="text-align:center; margin-bottom:20px;">Dialoghi & Frasi</h2>
                <select id="filtro-frasi" class="input-box" style="margin-bottom:15px;" onchange="renderFrasi()">
                    <option value="TUTTI">Tutti i Dialoghi</option>
                </select>
                <div style="text-align:center; margin-bottom:15px;">
                    <label style="cursor:pointer; color:#555;"><input type="checkbox" id="spoiler-check" onchange="renderFrasi()"> Nascondi Italiano</label>
                </div>
                <div id="lista-frasi"></div>
            </div>
        </div>

        <div id="tab-gestione" class="modulo-content hidden">
            <div class="card">
                <h2>Stato Dati</h2>
                <p>Vocaboli: <b id="count-v">0</b> | Frasi: <b id="count-f">0</b></p>
                <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                    <button class="btn btn-blue" onclick="forceSync()">üîÑ Forza Aggiornamento</button>
                    <button class="btn btn-red" style="margin-top:10px;" onclick="resetTotale()">üóë Reset Completo</button>
                </div>
            </div>
        </div>

        <div id="tab-hiragana" class="modulo-content hidden">
            <div class="card">
                <h2>Hiragana</h2>
                <div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:20px;">
                    <label class="mix-toggle"><input type="checkbox" id="h-mix-mode"> üîÄ Modalit√† Mista (Include Scelta Multipla)</label>
                    <div class="config-grid" id="h-config"></div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="btn btn-blue" style="padding:10px;" onclick="toggleKana('h', true)">Tutto</button>
                        <button class="btn btn-blue" style="padding:10px;" onclick="toggleKana('h', false)">Nulla</button>
                    </div>
                    <button class="btn btn-green" onclick="startKanaQuiz('h')">AVVIA QUIZ HIRAGANA</button>
                </div>
                <div style="overflow-x:auto;"><table class="kana-table" id="h-table"></table></div>
            </div>
        </div>

        <div id="tab-katakana" class="modulo-content hidden">
            <div class="card">
                <h2>Katakana</h2>
                <div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:20px;">
                    <label class="mix-toggle"><input type="checkbox" id="k-mix-mode"> üîÄ Modalit√† Mista (Include Scelta Multipla)</label>
                    <div class="config-grid" id="k-config"></div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="btn btn-blue" style="padding:10px;" onclick="toggleKana('k', true)">Tutto</button>
                        <button class="btn btn-blue" style="padding:10px;" onclick="toggleKana('k', false)">Nulla</button>
                    </div>
                    <button class="btn btn-green" onclick="startKanaQuiz('k')">AVVIA QUIZ KATAKANA</button>
                </div>
                <div style="overflow-x:auto;"><table class="kana-table" id="k-table"></table></div>
            </div>
        </div>

    </div>

    <script>
        const LINK_VOCABOLI = "https://raw.githubusercontent.com/cecifabrizio-beep/japan/refs/heads/main/importa.csv";
        const LINK_FRASI = "https://raw.githubusercontent.com/cecifabrizio-beep/japan/refs/heads/main/frasi.csv";

        const RAW_HIRAGANA=[{k:'„ÅÇ',r:'a'},{k:'„ÅÑ',r:'i'},{k:'„ÅÜ',r:'u'},{k:'„Åà',r:'e'},{k:'„Åä',r:'o'},{k:'„Åã',r:'ka'},{k:'„Åç',r:'ki'},{k:'„Åè',r:'ku'},{k:'„Åë',r:'ke'},{k:'„Åì',r:'ko'},{k:'„Åï',r:'sa'},{k:'„Åó',r:'shi'},{k:'„Åô',r:'su'},{k:'„Åõ',r:'se'},{k:'„Åù',r:'so'},{k:'„Åü',r:'ta'},{k:'„Å°',r:'chi'},{k:'„Å§',r:'tsu'},{k:'„Å¶',r:'te'},{k:'„Å®',r:'to'},{k:'„Å™',r:'na'},{k:'„Å´',r:'ni'},{k:'„Å¨',r:'nu'},{k:'„Å≠',r:'ne'},{k:'„ÅÆ',r:'no'},{k:'„ÅØ',r:'ha'},{k:'„Å≤',r:'hi'},{k:'„Åµ',r:'fu'},{k:'„Å∏',r:'he'},{k:'„Åª',r:'ho'},{k:'„Åæ',r:'ma'},{k:'„Åø',r:'mi'},{k:'„ÇÄ',r:'mu'},{k:'„ÇÅ',r:'me'},{k:'„ÇÇ',r:'mo'},{k:'„ÇÑ',r:'ya'},{k:'„ÇÜ',r:'yu'},{k:'„Çà',r:'yo'},{k:'„Çâ',r:'ra'},{k:'„Çä',r:'ri'},{k:'„Çã',r:'ru'},{k:'„Çå',r:'re'},{k:'„Çç',r:'ro'},{k:'„Çè',r:'wa'},{k:'„Çí',r:'wo'},{k:'„Çì',r:'n'},{k:'„Åå',r:'ga'},{k:'„Åé',r:'gi'},{k:'„Åê',r:'gu'},{k:'„Åí',r:'ge'},{k:'„Åî',r:'go'},{k:'„Åñ',r:'za'},{k:'„Åò',r:'ji'},{k:'„Åö',r:'zu'},{k:'„Åú',r:'ze'},{k:'„Åû',r:'zo'},{k:'„Å†',r:'da'},{k:'„Å¢',r:'ji'},{k:'„Å•',r:'zu'},{k:'„Åß',r:'de'},{k:'„Å©',r:'do'},{k:'„Å∞',r:'ba'},{k:'„Å≥',r:'bi'},{k:'„Å∂',r:'bu'},{k:'„Åπ',r:'be'},{k:'„Åº',r:'bo'},{k:'„Å±',r:'pa'},{k:'„Å¥',r:'pi'},{k:'„Å∑',r:'pu'},{k:'„Å∫',r:'pe'},{k:'„ÅΩ',r:'po'},{k:'„Åç„ÇÉ',r:'kya'},{k:'„Åç„ÇÖ',r:'kyu'},{k:'„Åç„Çá',r:'kyo'},{k:'„Åó„ÇÉ',r:'sha'},{k:'„Åó„ÇÖ',r:'shu'},{k:'„Åó„Çá',r:'sho'},{k:'„Å°„ÇÉ',r:'cha'},{k:'„Å°„ÇÖ',r:'chu'},{k:'„Å°„Çá',r:'cho'},{k:'„Å´„ÇÉ',r:'nya'},{k:'„Å´„ÇÖ',r:'nyu'},{k:'„Å´„Çá',r:'nyo'},{k:'„Å≤„ÇÉ',r:'hya'},{k:'„Å≤„ÇÖ',r:'hyu'},{k:'„Å≤„Çá',r:'hyo'},{k:'„Åø„ÇÉ',r:'mya'},{k:'„Åø„ÇÖ',r:'myu'},{k:'„Åø„Çá',r:'myo'},{k:'„Çä„ÇÉ',r:'rya'},{k:'„Çä„ÇÖ',r:'ryu'},{k:'„Çä„Çá',r:'ryo'},{k:'„Åé„ÇÉ',r:'gya'},{k:'„Åé„ÇÖ',r:'gyu'},{k:'„Åé„Çá',r:'gyo'},{k:'„Åò„ÇÉ',r:'ja'},{k:'„Åò„ÇÖ',r:'ju'},{k:'„Åò„Çá',r:'jo'},{k:'„Å≥„ÇÉ',r:'bya'},{k:'„Å≥„ÇÖ',r:'byu'},{k:'„Å≥„Çá',r:'byo'},{k:'„Å¥„ÇÉ',r:'pya'},{k:'„Å¥„ÇÖ',r:'pyu'},{k:'„Å¥„Çá',r:'pyo'}];
        const RAW_KATAKANA=[{k:'„Ç¢',r:'a'},{k:'„Ç§',r:'i'},{k:'„Ç¶',r:'u'},{k:'„Ç®',r:'e'},{k:'„Ç™',r:'o'},{k:'„Ç´',r:'ka'},{k:'„Ç≠',r:'ki'},{k:'„ÇØ',r:'ku'},{k:'„Ç±',r:'ke'},{k:'„Ç≥',r:'ko'},{k:'„Çµ',r:'sa'},{k:'„Ç∑',r:'shi'},{k:'„Çπ',r:'su'},{k:'„Çª',r:'se'},{k:'„ÇΩ',r:'so'},{k:'„Çø',r:'ta'},{k:'„ÉÅ',r:'chi'},{k:'„ÉÑ',r:'tsu'},{k:'„ÉÜ',r:'te'},{k:'„Éà',r:'to'},{k:'„Éä',r:'na'},{k:'„Éã',r:'ni'},{k:'„Éå',r:'nu'},{k:'„Éç',r:'ne'},{k:'„Éé',r:'no'},{k:'„Éè',r:'ha'},{k:'„Éí',r:'hi'},{k:'„Éï',r:'fu'},{k:'„Éò',r:'he'},{k:'„Éõ',r:'ho'},{k:'„Éû',r:'ma'},{k:'„Éü',r:'mi'},{k:'„É†',r:'mu'},{k:'„É°',r:'me'},{k:'„É¢',r:'mo'},{k:'„É§',r:'ya'},{k:'„É¶',r:'yu'},{k:'„É®',r:'yo'},{k:'„É©',r:'ra'},{k:'„É™',r:'ri'},{k:'„É´',r:'ru'},{k:'„É¨',r:'re'},{k:'„É≠',r:'ro'},{k:'„ÉØ',r:'wa'},{k:'„É≤',r:'wo'},{k:'„É≥',r:'n'},{k:'„Ç¨',r:'ga'},{k:'„ÇÆ',r:'gi'},{k:'„Ç∞',r:'gu'},{k:'„Ç≤',r:'ge'},{k:'„Ç¥',r:'go'},{k:'„Ç∂',r:'za'},{k:'„Ç∏',r:'ji'},{k:'„Ç∫',r:'zu'},{k:'„Çº',r:'ze'},{k:'„Çæ',r:'zo'},{k:'„ÉÄ',r:'da'},{k:'„ÉÇ',r:'ji'},{k:'„ÉÖ',r:'zu'},{k:'„Éá',r:'de'},{k:'„Éâ',r:'do'},{k:'„Éê',r:'ba'},{k:'„Éì',r:'bi'},{k:'„Éñ',r:'bu'},{k:'„Éô',r:'be'},{k:'„Éú',r:'bo'},{k:'„Éë',r:'pa'},{k:'„Éî',r:'pi'},{k:'„Éó',r:'pu'},{k:'„Éö',r:'pe'},{k:'„Éù',r:'po'},{k:'„Ç≠„É£',r:'kya'},{k:'„Ç≠„É•',r:'kyu'},{k:'„Ç≠„Éß',r:'kyo'},{k:'„Ç∑„É£',r:'sha'},{k:'„Ç∑„É•',r:'shu'},{k:'„Ç∑„Éß',r:'sho'},{k:'„ÉÅ„É£',r:'cha'},{k:'„ÉÅ„É•',r:'chu'},{k:'„ÉÅ„Éß',r:'cho'},{k:'„Éã„É£',r:'nya'},{k:'„Éã„É•',r:'nyu'},{k:'„Éã„Éß',r:'nyo'},{k:'„Éí„É£',r:'hya'},{k:'„Éí„É•',r:'hyu'},{k:'„Éí„Éß',r:'hyo'},{k:'„Éü„É£',r:'mya'},{k:'„Éü„É•',r:'myu'},{k:'„Éü„Éß',r:'myo'},{k:'„É™„É£',r:'rya'},{k:'„É™„É•',r:'ryu'},{k:'„É™„Éß',r:'ryo'},{k:'„ÇÆ„É£',r:'gya'},{k:'„ÇÆ„É•',r:'gyu'},{k:'„ÇÆ„Éß',r:'gyo'},{k:'„Ç∏„É£',r:'ja'},{k:'„Ç∏„É•',r:'ju'},{k:'„Ç∏„Éß',r:'jo'},{k:'„Éì„É£',r:'bya'},{k:'„Éì„É•',r:'byu'},{k:'„Éì„Éß',r:'byo'},{k:'„Éî„É£',r:'pya'},{k:'„Éî„É•',r:'pyu'},{k:'„Éî„Éß',r:'pyo'}];
        const KANA_GROUPS = {'Vocali':[0,5],'K':[5,10],'S':[10,15],'T':[15,20],'N':[20,25],'H':[25,30],'M':[30,35],'Y':[35,38],'R':[38,43],'W/N':[43,46],'Dakuten':[46,71],'Yoon':[71,104]};

        let vocaboli = []; let frasi = []; let sessione = []; let errori = []; let card = null;
        let punteggio = { ok:0, err:0 }; let mode = 'vocab'; let mixMode = false; let activePool = [];
        let currentKanaPrefix = 'h'; // Traccia se siamo in Hiragana o Katakana

        window.onload = function() {
            try {
                if(localStorage.getItem('srs_vocab_v19')) vocaboli = JSON.parse(localStorage.getItem('srs_vocab_v19'));
                if(localStorage.getItem('srs_frasi_v19')) frasi = JSON.parse(localStorage.getItem('srs_frasi_v19'));
            } catch(e) { localStorage.clear(); }

            aggiornaConta(); popolaFiltri();
            renderTabelle('h', RAW_HIRAGANA); renderTabelle('k', RAW_KATAKANA); renderFrasi(); renderStudio();
            
            if(vocaboli.length === 0) forceSync();

            document.getElementById('input-risposta').addEventListener('keydown', function(e){
                if(e.key === 'Enter' && !this.classList.contains('hidden')) {
                    if(!document.getElementById('btn-check').classList.contains('hidden')) controlla();
                    else prossima();
                }
            });
        };

        function showNotification(msg, type) {
            const el = document.getElementById('sync-status');
            el.className = type; el.innerText = msg; el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 4000);
        }

        function forceSync() {
            showNotification("Download dati in corso...", "sync-loading");
            const ts = new Date().getTime();
            Promise.all([ 
                fetch(LINK_VOCABOLI + "?t=" + ts).then(r => r.ok ? r.text() : Promise.reject('Err Vocab')), 
                fetch(LINK_FRASI + "?t=" + ts).then(r => r.ok ? r.text() : Promise.reject('Err Frasi')) 
            ])
            .then(([txtV, txtF]) => {
                const countV = parseCSV(txtV, 'vocab', false);
                const countF = parseCSV(txtF, 'frasi', false);
                showNotification(`Aggiornato! V:${countV} F:${countF}`, "sync-success");
                aggiornaConta(); popolaFiltri(); renderFrasi(); renderStudio();
                if(vocaboli.length > 0) openVocabQuiz(); 
            }).catch(e => { 
                console.error(e);
                showNotification("Errore Scaricamento Dati", "sync-error"); 
            });
        }

        function switchTab(id, btnElement) {
            document.querySelectorAll('.modulo-content').forEach(d => d.classList.add('hidden'));
            document.getElementById('tab-'+id).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
            else {
                // Fallback visuale se chiamo switchTab via codice
                const navBtn = document.querySelector(`button[onclick*="'${id}'"]`);
                if(navBtn) navBtn.classList.add('active');
            }
        }

        // --- STUDIO ---
        function renderStudio() {
            const div = document.getElementById('lista-studio');
            const filter = document.getElementById('filtro-studio').value;
            div.innerHTML = '';
            
            const list = (filter === 'TUTTI') ? vocaboli : vocaboli.filter(v => v.tag === filter);
            if(list.length === 0) { div.innerHTML = '<p style="text-align:center; padding:20px;">Nessun vocabolo.</p>'; return; }

            div.innerHTML = list.map(v => {
                const jpnSafe = v.jpn.replace(/'/g,"\\'");
                return `
                    <div class="list-entry">
                        <button class="play-btn" onclick="parla('${jpnSafe}')">‚ñ∂</button>
                        <div class="list-text">
                            <span class="txt-jpn">${v.jpn}</span>
                            <span class="txt-rom">${v.rom}</span>
                            <span class="txt-ita">${v.ita} ${v.eng ? `<small style="color:#888">(${v.eng})</small>` : ''}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- QUIZ LOGIC ---
        function openVocabQuiz() {
            mode = 'vocab';
            document.getElementById('filtro-cat').classList.remove('hidden');
            nuovaSessione();
        }

        function nuovaSessione() {
            document.getElementById('end-session-box').classList.add('hidden');
            document.getElementById('quiz-area').classList.remove('hidden');
            
            if(mode === 'vocab') {
                const cat = document.getElementById('filtro-cat').value;
                const pool = (cat === 'TUTTI') ? vocaboli : vocaboli.filter(v => v.tag === cat);
                if(pool.length === 0) {
                    document.getElementById('quiz-area').classList.add('hidden');
                    document.getElementById('msg-no-data').classList.remove('hidden');
                    return;
                }
                document.getElementById('msg-no-data').classList.add('hidden');
                sessione = pool.sort(() => 0.5 - Math.random()).slice(0, 10);
            }
            errori = []; punteggio = { ok:0, err:0 }; prossima();
        }

        function avviaRipasso() {
            sessione = [...errori]; errori = []; 
            document.getElementById('end-session-box').classList.add('hidden');
            document.getElementById('quiz-area').classList.remove('hidden');
            prossima();
        }

        function prossima() {
            if(sessione.length === 0) {
                concludiSessione();
                return;
            }

            card = sessione.pop();
            const input = document.getElementById('input-risposta');
            const choicesDiv = document.getElementById('choices-area');
            const feed = document.getElementById('feedback');
            const btnCheck = document.getElementById('btn-check');
            const btnNext = document.getElementById('btn-next');

            feed.classList.add('hidden'); feed.classList.remove('fb-corretto', 'fb-sbagliato');
            btnNext.classList.add('hidden');
            document.getElementById('punteggio').innerText = `Corretti: ${punteggio.ok} | Errori: ${punteggio.err}`;

            let showInput = true;

            if(mode === 'vocab') {
                const dir = Math.random() > 0.5 ? 'j2i' : 'i2j';
                card.dir = dir;
                if(dir === 'j2i') {
                    document.getElementById('q-label').innerText = "TRADUCI IN ITALIANO";
                    document.getElementById('prompt-principale').innerHTML = `${card.jpn} <span style="font-size:1.5rem; cursor:pointer;" onclick="parla('${card.jpn.replace(/'/g,"\\'")} ')">üîä</span>`;
                    document.getElementById('prompt-secondario').innerText = card.rom;
                } else {
                    document.getElementById('q-label').innerText = "TRADUCI IN GIAPPONESE (ROMAJI)";
                    document.getElementById('prompt-principale').innerText = card.ita;
                    document.getElementById('prompt-secondario').innerText = card.eng || "";
                }
            } else {
                let dir = 'k2r';
                if(mixMode && Math.random() > 0.5) dir = 'r2k';
                card.dir = dir;

                if(dir === 'k2r') {
                    document.getElementById('q-label').innerText = "SCRIVI IL ROMAJI";
                    document.getElementById('prompt-principale').innerText = card.k;
                    document.getElementById('prompt-secondario').innerText = "";
                } else {
                    document.getElementById('q-label').innerText = "SELEZIONA IL KANA";
                    document.getElementById('prompt-principale').innerText = card.r;
                    document.getElementById('prompt-secondario').innerText = "";
                    showInput = false;
                    generaScelte(card);
                }
            }

            if(showInput) {
                input.value = ''; input.disabled = false; 
                input.classList.remove('hidden'); choicesDiv.classList.add('hidden');
                btnCheck.classList.remove('hidden'); input.focus();
            } else {
                input.classList.add('hidden'); choicesDiv.classList.remove('hidden');
                btnCheck.classList.add('hidden');
            }
        }

        function concludiSessione() {
            document.getElementById('quiz-area').classList.add('hidden');
            document.getElementById('end-session-box').classList.remove('hidden');
            
            let msg = "Sessione Perfetta!";
            if(errori.length > 0) msg = "Sessione Conclusa";
            document.getElementById('end-msg').innerText = msg;
            document.getElementById('end-stat').innerText = `Punteggio: ${punteggio.ok} giuste, ${punteggio.err} errori.`;
            
            const btnRip = document.getElementById('btn-ripasso');
            if(errori.length > 0) { 
                btnRip.classList.remove('hidden'); 
                btnRip.innerText = `üîÅ Ripassa ${errori.length} Errori`; 
            } else { 
                btnRip.classList.add('hidden'); 
            }

            // GESTIONE DEL TASTO FINALE (SMART)
            const btnNew = document.getElementById('btn-new-session');
            if(mode === 'vocab') {
                btnNew.innerText = "Nuova Sessione Vocaboli";
                btnNew.onclick = openVocabQuiz;
            } else {
                // √à Kana
                const label = (currentKanaPrefix === 'h') ? "Hiragana" : "Katakana";
                btnNew.innerText = `Torna a ${label}`;
                btnNew.onclick = function() {
                    switchTab(currentKanaPrefix === 'h' ? 'hiragana' : 'katakana');
                };
            }
        }

        function generaScelte(corretta) {
            const div = document.getElementById('choices-area'); div.innerHTML = '';
            let pool = activePool.filter(x => x.k !== corretta.k);
            if(pool.length < 3) {
               pool = (mode==='kana' && corretta.k.match(/[„ÅÇ-„Çì]/)) ? RAW_HIRAGANA : RAW_KATAKANA;
               pool = pool.filter(x => x.k !== corretta.k);
            }
            let options = pool.sort(() => 0.5 - Math.random()).slice(0, 3);
            options.push(corretta); options.sort(() => 0.5 - Math.random()); 

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn'; btn.innerText = opt.k;
                btn.onclick = () => verificaScelta(opt, corretta, btn);
                div.appendChild(btn);
            });
        }

        function verificaScelta(selezionata, corretta, btnElement) {
            const btns = document.querySelectorAll('.choice-btn');
            btns.forEach(b => b.disabled = true); 
            const feed = document.getElementById('feedback');
            feed.classList.remove('hidden', 'fb-corretto', 'fb-sbagliato');

            if(selezionata.k === corretta.k) {
                punteggio.ok++; btnElement.classList.add('btn-correct');
                feed.classList.add('fb-corretto'); feed.innerText = "‚úÖ Esatto!";
            } else {
                punteggio.err++; errori.push(card); btnElement.classList.add('btn-wrong');
                feed.classList.add('fb-sbagliato'); feed.innerHTML = `‚ùå Sbagliato! Era: <b>${corretta.k}</b>`;
                btns.forEach(b => { if(b.innerText === corretta.k) b.classList.add('btn-correct'); });
            }
            document.getElementById('btn-next').classList.remove('hidden');
            document.getElementById('btn-next').focus();
        }

        // --- TOLLERANZA (Smart Check) ---
        function cleanText(text) { return text.toLowerCase().replace(/[.,?Ôºü„ÄÇ„ÄÅ!ÔºÅ]/g, '').trim(); }

        function controlla() {
            const input = document.getElementById('input-risposta');
            const feed = document.getElementById('feedback');
            const user = cleanText(input.value);
            let ok = false; let ans = "";

            if(mode === 'vocab') {
                if(card.dir === 'j2i') {
                    if(user == cleanText(card.ita) || (card.eng && user == cleanText(card.eng))) ok = true;
                    ans = card.ita;
                } else {
                    if(user == cleanText(card.rom) || user == cleanText(card.jpn)) ok = true;
                    ans = `${card.rom} (${card.jpn})`;
                }
            } else {
                if(user == cleanText(card.r)) ok = true; ans = card.r;
            }

            feed.classList.remove('hidden', 'fb-corretto', 'fb-sbagliato');
            const jpnSafe = (mode === 'vocab') ? card.jpn.replace(/'/g, "\\'") : '';
            const audioBtn = (mode === 'vocab') ? ` <span style="cursor:pointer; font-size:1.2rem" onclick="parla('${jpnSafe}')">üîä</span>` : '';

            if(ok) {
                punteggio.ok++; feed.classList.add('fb-corretto'); 
                feed.innerHTML = "‚úÖ Esatto!" + audioBtn; 
            } else {
                punteggio.err++; errori.push(card); 
                feed.classList.add('fb-sbagliato'); 
                feed.innerHTML = `‚ùå Sbagliato! Era: <b>${ans}</b>` + audioBtn;
            }
            input.disabled = true;
            document.getElementById('btn-check').classList.add('hidden');
            document.getElementById('btn-next').classList.remove('hidden');
            document.getElementById('btn-next').focus();
        }

        // --- KANA CONFIG ---
        function renderTabelle(prefix, data) {
            const t = document.getElementById(prefix+'-table');
            let html = '<tr>';
            for(let i=0; i<data.length; i++) {
                html += `<td><span class="kc">${data[i].k}</span><span class="kr">${data[i].r}</span></td>`;
                if((i+1)%5 === 0) html += '</tr><tr>';
            }
            t.innerHTML = html;
            const conf = document.getElementById(prefix+'-config');
            let chkHtml = '';
            Object.keys(KANA_GROUPS).forEach(key => {
                 chkHtml += `<label class="checkbox-label"><input type="checkbox" value="${key}" checked> ${key}</label>`;
            });
            conf.innerHTML = chkHtml;
        }

        function toggleKana(prefix, state) { document.querySelectorAll(`#${prefix}-config input`).forEach(c => c.checked = state); }

        function startKanaQuiz(prefix) {
            currentKanaPrefix = prefix; // Salva se H o K per il ritorno
            const dataset = (prefix==='h') ? RAW_HIRAGANA : RAW_KATAKANA;
            const checkboxes = document.querySelectorAll(`#${prefix}-config input:checked`);
            const mixCheck = document.getElementById(prefix + '-mix-mode');
            mixMode = mixCheck.checked;
            let pool = [];
            checkboxes.forEach(chk => { 
                const range = KANA_GROUPS[chk.value]; 
                if(range) pool = pool.concat(dataset.slice(range[0], range[1])); 
            });
            if(pool.length === 0) { alert("Seleziona almeno una riga"); return; }
            
            activePool = pool;
            sessione = pool.sort(() => 0.5 - Math.random());
            mode = 'kana';
            
            switchTab('quiz', document.querySelector(`button[onclick*="switchTab('${prefix==='h'?'hiragana':'katakana'}"]`));
            document.getElementById('filtro-cat').classList.add('hidden');
            nuovaSessione(); 
        }

        // --- PARSER ---
        function parseCSV(text, type, reload) {
            const lines = text.trim().split('\n');
            let count = 0;
            if(type === 'vocab') {
                vocaboli = [];
                lines.forEach(l => {
                    const sep = l.includes('|') ? '|' : ','; const p = l.split(sep);
                    if(p.length >= 4) { vocaboli.push({ita:p[0].trim(), eng:p[1].trim(), jpn:p[2].trim(), rom:p[3].trim(), tag:p[4]?p[4].trim():'Gen'}); count++; }
                });
                localStorage.setItem('srs_vocab_v19', JSON.stringify(vocaboli));
            } else {
                frasi = [];
                lines.forEach(l => {
                    const sep = l.includes('|') ? '|' : ','; const p = l.split(sep);
                    if(p.length >= 3) { frasi.push({ita:p[0].trim(), rom:p[1].trim(), jpn:p[2].trim(), tag:p[3]?p[3].trim():'Gen'}); count++; }
                });
                localStorage.setItem('srs_frasi_v19', JSON.stringify(frasi));
            }
            if(reload) location.reload();
            return count;
        }

        function resetTotale() { 
            if(confirm("Sicuro di voler cancellare tutti i dati salvati?")) { 
                localStorage.clear(); 
                location.reload(); 
            } 
        }
        function aggiornaConta() { document.getElementById('count-v').innerText = vocaboli.length; document.getElementById('count-f').innerText = frasi.length; }
        
        function popolaFiltri() {
            const s = document.getElementById('filtro-cat'); s.innerHTML = '<option value="TUTTI">Tutte le Categorie</option>';
            const s2 = document.getElementById('filtro-studio'); s2.innerHTML = '<option value="TUTTI">Tutte le Categorie</option>';
            
            const tags = new Set(vocaboli.map(v => v.tag));
            tags.forEach(t => {
                s.innerHTML += `<option value="${t}">${t}</option>`;
                s2.innerHTML += `<option value="${t}">${t}</option>`;
            });

            const f = document.getElementById('filtro-frasi'); f.innerHTML = '<option value="TUTTI">Tutti i Dialoghi</option>';
            const fTags = new Set(frasi.map(v => v.tag));
            fTags.forEach(t => f.innerHTML += `<option value="${t}">${t}</option>`);
        }

        function renderFrasi() {
            const div = document.getElementById('lista-frasi'); 
            const spoiler = document.getElementById('spoiler-check').checked; 
            const filter = document.getElementById('filtro-frasi').value;
            div.innerHTML = ''; 
            
            const list = (filter === 'TUTTI') ? frasi : frasi.filter(f => f.tag === filter);
            if(list.length === 0) { div.innerHTML = '<p style="text-align:center">Nessuna frase</p>'; return; }
            
            div.innerHTML = list.map(f => {
                const jpnSafe = f.jpn.replace(/'/g,"\\'");
                return `<div class="list-entry ${spoiler?'spoiler':''}"><button class="play-btn" onclick="parla('${jpnSafe}')">‚ñ∂</button><div class="list-text"><span class="txt-jpn">${f.jpn}</span><span class="txt-rom">${f.rom}</span><span class="txt-ita">${f.ita}</span></div></div>`;
            }).join('');
        }

        function parla(t) { 
            if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(t); 
                u.lang = 'ja-JP'; 
                u.rate = 0.9; // Leggermente pi√π lento per studio
                window.speechSynthesis.speak(u); 
            } else {
                alert("Il tuo browser non supporta la sintesi vocale.");
            }
        }
    </script>
</body>
</html>
