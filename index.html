<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giapponese SRS v8.0 (Safe)</title>
    <style>
        /* --- STILE GENERALE --- */
        body { font-family: -apple-system, sans-serif; background-color: #f2f2f7; color: #333; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        h1 { color: #1c1c1e; margin-bottom: 20px; text-align: center; }
        .container { width: 100%; max-width: 600px; margin-bottom: 50px; }
        .card { background: #ffffff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .hidden { display: none !important; }

        /* --- MENU --- */
        #main-nav { display: flex; gap: 5px; width: 100%; max-width: 600px; margin-bottom: 20px; overflow-x: auto; }
        .nav-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; background-color: #e5e5ea; color: #007aff; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .nav-btn.active { background-color: #007aff; color: white; }

        /* --- UI --- */
        .input-box { width: 100%; padding: 12px; font-size: 1.1rem; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; text-align: center; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; color: white; margin-top: 5px; }
        .btn-blue { background-color: #007aff; } .btn-green { background-color: #34c759; } .btn-red { background-color: #ff3b30; }

        /* --- QUIZ --- */
        #prompt-principale { font-size: 2.2rem; margin: 10px 0; text-align: center; }
        #prompt-secondario { font-size: 1.1rem; color: #666; font-style: italic; text-align: center; }
        #risultato-controllo { text-align: center; font-weight: bold; min-height: 30px; margin: 10px 0; }
        .corretto { color: #34c759; } .sbagliato { color: #ff3b30; }

        /* --- ASCOLTO --- */
        .frase-entry { display: flex; align-items: center; background: #f9f9f9; border: 1px solid #eee; border-radius: 10px; padding: 12px; margin-bottom: 10px; gap: 12px; }
        .play-btn { width: 40px; height: 40px; border-radius: 50%; background: #34c759; color: white; border: none; cursor: pointer; flex-shrink: 0; }
        .spoiler .frase-ita { background: #ddd; color: transparent; border-radius: 4px; }
        .spoiler .frase-ita:hover { background: transparent; color: #007aff; }

        /* --- KANA --- */
        .kana-table { width: 100%; border-collapse: collapse; text-align: center; margin-bottom: 20px; }
        .kana-table th { background: #f2f2f7; padding: 5px; font-size: 0.8rem; }
        .kana-table td { border: 1px solid #ddd; padding: 5px; }
        .kc { font-size: 1.2rem; font-weight: bold; display: block; }
        .kr { font-size: 0.7rem; color: #888; }
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h1>Set di Studio Giapponese</h1>

    <nav id="main-nav">
        <button class="nav-btn active" onclick="switchTab('quiz')">Quiz</button>
        <button class="nav-btn" onclick="switchTab('ascolto')">Ascolto</button>
        <button class="nav-btn" onclick="switchTab('hiragana')">Hiragana</button>
        <button class="nav-btn" onclick="switchTab('katakana')">Katakana</button>
        <button class="nav-btn" onclick="switchTab('gestione')">Gestione</button>
    </nav>

    <div class="container">

        <div id="tab-quiz" class="modulo-content">
            <div class="card">
                <div style="text-align:center; margin-bottom:10px; color:#888;" id="punteggio">Pronto</div>
                <select id="filtro-cat" class="input-box" onchange="nuovaSessione()"><option value="TUTTI">Tutte le Categorie</option></select>
                
                <div id="quiz-area">
                    <div style="text-align:center; color:#aaa; font-size:0.8rem;" id="q-label">DOMANDA</div>
                    <div id="prompt-principale">...</div>
                    <div id="prompt-secondario">...</div>
                    <input type="text" id="input-risposta" class="input-box" placeholder="Scrivi qui..." autocomplete="off">
                    <div id="risultato-controllo"></div>
                    <button id="btn-check" class="btn btn-blue" onclick="controlla()">Controlla</button>
                    <button id="btn-next" class="btn btn-green hidden" onclick="prossima()">Prossima</button>
                </div>
                <div id="msg-no-data" class="hidden" style="text-align:center; padding:20px;">Nessun vocabolo. Vai in Gestione.</div>
            </div>
        </div>

        <div id="tab-ascolto" class="modulo-content hidden">
            <div class="card">
                <h2>Ascolto Frasi</h2>
                <label style="display:block; text-align:center; margin-bottom:10px;">
                    <input type="checkbox" id="spoiler-check" onchange="renderFrasi()"> Nascondi Italiano
                </label>
                <div id="lista-frasi"></div>
            </div>
        </div>

        <div id="tab-gestione" class="modulo-content hidden">
            <div class="card">
                <h2>Gestione Dati</h2>
                
                <div style="border:1px dashed #ccc; padding:15px; margin-bottom:15px; border-radius:8px;">
                    <h3>Importa Vocaboli (CSV)</h3>
                    <input type="text" id="url-vocab" class="input-box" placeholder="Link RAW GitHub...">
                    <button class="btn btn-blue" onclick="scarica('vocab')">Scarica da GitHub</button>
                    <p style="text-align:center; margin:5px;">oppure</p>
                    <input type="file" onchange="leggiFile(this, 'vocab')">
                </div>

                <div style="border:1px dashed #ccc; padding:15px; margin-bottom:15px; border-radius:8px;">
                    <h3>Importa Frasi (CSV)</h3>
                    <input type="text" id="url-frasi" class="input-box" placeholder="Link RAW GitHub...">
                    <button class="btn btn-blue" onclick="scarica('frasi')">Scarica da GitHub</button>
                    <p style="text-align:center; margin:5px;">oppure</p>
                    <input type="file" onchange="leggiFile(this, 'frasi')">
                </div>

                <div style="text-align:center;">
                    <p>Vocaboli: <b id="count-v">0</b> | Frasi: <b id="count-f">0</b></p>
                    <button class="btn btn-red" onclick="resetTotale()">CANCELLA TUTTO</button>
                </div>
            </div>
        </div>

        <div id="tab-hiragana" class="modulo-content hidden">
            <div class="card">
                <h2>Hiragana</h2>
                <div style="background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:15px;">
                    <div class="config-grid" id="h-config"></div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-blue" style="font-size:0.8rem; padding:5px;" onclick="toggleKana('h', true)">Tutto</button>
                        <button class="btn btn-blue" style="font-size:0.8rem; padding:5px;" onclick="toggleKana('h', false)">Nulla</button>
                    </div>
                    <button class="btn btn-green" onclick="startKanaQuiz('h')">AVVIA QUIZ</button>
                </div>
                <div style="overflow-x:auto;">
                    <table class="kana-table">
                        <tr><th>-</th><th>K</th><th>S</th><th>T</th><th>N</th><th>H</th><th>M</th><th>Y</th><th>R</th><th>W</th><th>N</th></tr>
                        <tr><td><span class="kc">„ÅÇ</span></td><td><span class="kc">„Åã</span></td><td><span class="kc">„Åï</span></td><td><span class="kc">„Åü</span></td><td><span class="kc">„Å™</span></td><td><span class="kc">„ÅØ</span></td><td><span class="kc">„Åæ</span></td><td><span class="kc">„ÇÑ</span></td><td><span class="kc">„Çâ</span></td><td><span class="kc">„Çè</span></td><td><span class="kc">„Çì</span></td></tr>
                        <tr><td><span class="kc">„ÅÑ</span></td><td><span class="kc">„Åç</span></td><td><span class="kc">„Åó</span></td><td><span class="kc">„Å°</span></td><td><span class="kc">„Å´</span></td><td><span class="kc">„Å≤</span></td><td><span class="kc">„Åø</span></td><td></td><td><span class="kc">„Çä</span></td><td></td><td></td></tr>
                        <tr><td><span class="kc">„ÅÜ</span></td><td><span class="kc">„Åè</span></td><td><span class="kc">„Åô</span></td><td><span class="kc">„Å§</span></td><td><span class="kc">„Å¨</span></td><td><span class="kc">„Åµ</span></td><td><span class="kc">„ÇÄ</span></td><td><span class="kc">„ÇÜ</span></td><td><span class="kc">„Çã</span></td><td></td><td></td></tr>
                        <tr><td><span class="kc">„Åà</span></td><td><span class="kc">„Åë</span></td><td><span class="kc">„Åõ</span></td><td><span class="kc">„Å¶</span></td><td><span class="kc">„Å≠</span></td><td><span class="kc">„Å∏</span></td><td><span class="kc">„ÇÅ</span></td><td></td><td><span class="kc">„Çå</span></td><td></td><td></td></tr>
                        <tr><td><span class="kc">„Åä</span></td><td><span class="kc">„Åì</span></td><td><span class="kc">„Åù</span></td><td><span class="kc">„Å®</span></td><td><span class="kc">„ÅÆ</span></td><td><span class="kc">„Åª</span></td><td><span class="kc">„ÇÇ</span></td><td><span class="kc">„Çà</span></td><td><span class="kc">„Çç</span></td><td><span class="kc">„Çí</span></td><td></td></tr>
                    </table>
                    <h4 style="text-align:center;">Dakuten</h4>
                    <table class="kana-table">
                        <tr><th>G</th><th>Z</th><th>D</th><th>B</th><th>P</th></tr>
                        <tr><td><span class="kc">„Åå</span></td><td><span class="kc">„Åñ</span></td><td><span class="kc">„Å†</span></td><td><span class="kc">„Å∞</span></td><td><span class="kc">„Å±</span></td></tr>
                        <tr><td><span class="kc">„Åé</span></td><td><span class="kc">„Åò</span></td><td><span class="kc">„Å¢</span></td><td><span class="kc">„Å≥</span></td><td><span class="kc">„Å¥</span></td></tr>
                        <tr><td><span class="kc">„Åê</span></td><td><span class="kc">„Åö</span></td><td><span class="kc">„Å•</span></td><td><span class="kc">„Å∂</span></td><td><span class="kc">„Å∑</span></td></tr>
                        <tr><td><span class="kc">„Åí</span></td><td><span class="kc">„Åú</span></td><td><span class="kc">„Åß</span></td><td><span class="kc">„Åπ</span></td><td><span class="kc">„Å∫</span></td></tr>
                        <tr><td><span class="kc">„Åî</span></td><td><span class="kc">„Åû</span></td><td><span class="kc">„Å©</span></td><td><span class="kc">„Åº</span></td><td><span class="kc">„ÅΩ</span></td></tr>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-katakana" class="modulo-content hidden">
            <div class="card">
                <h2>Katakana</h2>
                <div style="background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:15px;">
                    <div class="config-grid" id="k-config"></div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-blue" style="font-size:0.8rem; padding:5px;" onclick="toggleKana('k', true)">Tutto</button>
                        <button class="btn btn-blue" style="font-size:0.8rem; padding:5px;" onclick="toggleKana('k', false)">Nulla</button>
                    </div>
                    <button class="btn btn-green" onclick="startKanaQuiz('k')">AVVIA QUIZ</button>
                </div>
                <div style="overflow-x:auto;">
                    <table class="kana-table">
                        <tr><th>-</th><th>K</th><th>S</th><th>T</th><th>N</th><th>H</th><th>M</th><th>Y</th><th>R</th><th>W</th><th>N</th></tr>
                        <tr><td><span class="kc">„Ç¢</span></td><td><span class="kc">„Ç´</span></td><td><span class="kc">„Çµ</span></td><td><span class="kc">„Çø</span></td><td><span class="kc">„Éä</span></td><td><span class="kc">„Éè</span></td><td><span class="kc">„Éû</span></td><td><span class="kc">„É§</span></td><td><span class="kc">„É©</span></td><td><span class="kc">„ÉØ</span></td><td><span class="kc">„É≥</span></td></tr>
                        <tr><td><span class="kc">„Ç§</span></td><td><span class="kc">„Ç≠</span></td><td><span class="kc">„Ç∑</span></td><td><span class="kc">„ÉÅ</span></td><td><span class="kc">„Éã</span></td><td><span class="kc">„Éí</span></td><td><span class="kc">„Éü</span></td><td></td><td><span class="kc">„É™</span></td><td></td><td></td></tr>
                        <tr><td><span class="kc">„Ç¶</span></td><td><span class="kc">„ÇØ</span></td><td><span class="kc">„Çπ</span></td><td><span class="kc">„ÉÑ</span></td><td><span class="kc">„Éå</span></td><td><span class="kc">„Éï</span></td><td><span class="kc">„É†</span></td><td><span class="kc">„É¶</span></td><td><span class="kc">„É´</span></td><td></td><td></td></tr>
                        <tr><td><span class="kc">„Ç®</span></td><td><span class="kc">„Ç±</span></td><td><span class="kc">„Çª</span></td><td><span class="kc">„ÉÜ</span></td><td><span class="kc">„Éç</span></td><td><span class="kc">„Éò</span></td><td><span class="kc">„É°</span></td><td></td><td><span class="kc">„É¨</span></td><td></td><td></td></tr>
                        <tr><td><span class="kc">„Ç™</span></td><td><span class="kc">„Ç≥</span></td><td><span class="kc">„ÇΩ</span></td><td><span class="kc">„Éà</span></td><td><span class="kc">„Éé</span></td><td><span class="kc">„Éõ</span></td><td><span class="kc">„É¢</span></td><td><span class="kc">„É®</span></td><td><span class="kc">„É≠</span></td><td><span class="kc">„É≤</span></td><td></td></tr>
                    </table>
                    <h4 style="text-align:center;">Dakuten</h4>
                    <table class="kana-table">
                        <tr><th>G</th><th>Z</th><th>D</th><th>B</th><th>P</th></tr>
                        <tr><td><span class="kc">„Ç¨</span></td><td><span class="kc">„Ç∂</span></td><td><span class="kc">„ÉÄ</span></td><td><span class="kc">„Éê</span></td><td><span class="kc">„Éë</span></td></tr>
                        <tr><td><span class="kc">„ÇÆ</span></td><td><span class="kc">„Ç∏</span></td><td><span class="kc">„ÉÇ</span></td><td><span class="kc">„Éì</span></td><td><span class="kc">„Éî</span></td></tr>
                        <tr><td><span class="kc">„Ç∞</span></td><td><span class="kc">„Ç∫</span></td><td><span class="kc">„ÉÖ</span></td><td><span class="kc">„Éñ</span></td><td><span class="kc">„Éó</span></td></tr>
                        <tr><td><span class="kc">„Ç≤</span></td><td><span class="kc">„Çº</span></td><td><span class="kc">„Éá</span></td><td><span class="kc">„Éô</span></td><td><span class="kc">„Éö</span></td></tr>
                        <tr><td><span class="kc">„Ç¥</span></td><td><span class="kc">„Çæ</span></td><td><span class="kc">„Éâ</span></td><td><span class="kc">„Éú</span></td><td><span class="kc">„Éù</span></td></tr>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- COSTANTI ---
        const RAW_HIRAGANA = [
            {k:'„ÅÇ',r:'a'},{k:'„ÅÑ',r:'i'},{k:'„ÅÜ',r:'u'},{k:'„Åà',r:'e'},{k:'„Åä',r:'o'},
            {k:'„Åã',r:'ka'},{k:'„Åç',r:'ki'},{k:'„Åè',r:'ku'},{k:'„Åë',r:'ke'},{k:'„Åì',r:'ko'},
            {k:'„Åï',r:'sa'},{k:'„Åó',r:'shi'},{k:'„Åô',r:'su'},{k:'„Åõ',r:'se'},{k:'„Åù',r:'so'},
            {k:'„Åü',r:'ta'},{k:'„Å°',r:'chi'},{k:'„Å§',r:'tsu'},{k:'„Å¶',r:'te'},{k:'„Å®',r:'to'},
            {k:'„Å™',r:'na'},{k:'„Å´',r:'ni'},{k:'„Å¨',r:'nu'},{k:'„Å≠',r:'ne'},{k:'„ÅÆ',r:'no'},
            {k:'„ÅØ',r:'ha'},{k:'„Å≤',r:'hi'},{k:'„Åµ',r:'fu'},{k:'„Å∏',r:'he'},{k:'„Åª',r:'ho'},
            {k:'„Åæ',r:'ma'},{k:'„Åø',r:'mi'},{k:'„ÇÄ',r:'mu'},{k:'„ÇÅ',r:'me'},{k:'„ÇÇ',r:'mo'},
            {k:'„ÇÑ',r:'ya'},{k:'„ÇÜ',r:'yu'},{k:'„Çà',r:'yo'},
            {k:'„Çâ',r:'ra'},{k:'„Çä',r:'ri'},{k:'„Çã',r:'ru'},{k:'„Çå',r:'re'},{k:'„Çç',r:'ro'},
            {k:'„Çè',r:'wa'},{k:'„Çí',r:'wo'},{k:'„Çì',r:'n'},
            {k:'„Åå',r:'ga'},{k:'„Åé',r:'gi'},{k:'„Åê',r:'gu'},{k:'„Åí',r:'ge'},{k:'„Åî',r:'go'},
            {k:'„Åñ',r:'za'},{k:'„Åò',r:'ji'},{k:'„Åö',r:'zu'},{k:'„Åú',r:'ze'},{k:'„Åû',r:'zo'},
            {k:'„Å†',r:'da'},{k:'„Å¢',r:'ji'},{k:'„Å•',r:'zu'},{k:'„Åß',r:'de'},{k:'„Å©',r:'do'},
            {k:'„Å∞',r:'ba'},{k:'„Å≥',r:'bi'},{k:'„Å∂',r:'bu'},{k:'„Åπ',r:'be'},{k:'„Åº',r:'bo'},
            {k:'„Å±',r:'pa'},{k:'„Å¥',r:'pi'},{k:'„Å∑',r:'pu'},{k:'„Å∫',r:'pe'},{k:'„ÅΩ',r:'po'}
        ];
        
        const RAW_KATAKANA = [
            {k:'„Ç¢',r:'a'},{k:'„Ç§',r:'i'},{k:'„Ç¶',r:'u'},{k:'„Ç®',r:'e'},{k:'„Ç™',r:'o'},
            {k:'„Ç´',r:'ka'},{k:'„Ç≠',r:'ki'},{k:'„ÇØ',r:'ku'},{k:'„Ç±',r:'ke'},{k:'„Ç≥',r:'ko'},
            {k:'„Çµ',r:'sa'},{k:'„Ç∑',r:'shi'},{k:'„Çπ',r:'su'},{k:'„Çª',r:'se'},{k:'„ÇΩ',r:'so'},
            {k:'„Çø',r:'ta'},{k:'„ÉÅ',r:'chi'},{k:'„ÉÑ',r:'tsu'},{k:'„ÉÜ',r:'te'},{k:'„Éà',r:'to'},
            {k:'„Éä',r:'na'},{k:'„Éã',r:'ni'},{k:'„Éå',r:'nu'},{k:'„Éç',r:'ne'},{k:'„Éé',r:'no'},
            {k:'„Éè',r:'ha'},{k:'„Éí',r:'hi'},{k:'„Éï',r:'fu'},{k:'„Éò',r:'he'},{k:'„Éõ',r:'ho'},
            {k:'„Éû',r:'ma'},{k:'„Éü',r:'mi'},{k:'„É†',r:'mu'},{k:'„É°',r:'me'},{k:'„É¢',r:'mo'},
            {k:'„É§',r:'ya'},{k:'„É¶',r:'yu'},{k:'„É®',r:'yo'},
            {k:'„É©',r:'ra'},{k:'„É™',r:'ri'},{k:'„É´',r:'ru'},{k:'„É¨',r:'re'},{k:'„É≠',r:'ro'},
            {k:'„ÉØ',r:'wa'},{k:'„É≤',r:'wo'},{k:'„É≥',r:'n'},
            {k:'„Ç¨',r:'ga'},{k:'„ÇÆ',r:'gi'},{k:'„Ç∞',r:'gu'},{k:'„Ç≤',r:'ge'},{k:'„Ç¥',r:'go'},
            {k:'„Ç∂',r:'za'},{k:'„Ç∏',r:'ji'},{k:'„Ç∫',r:'zu'},{k:'„Çº',r:'ze'},{k:'„Çæ',r:'zo'},
            {k:'„ÉÄ',r:'da'},{k:'„ÉÇ',r:'ji'},{k:'„ÉÖ',r:'zu'},{k:'„Éá',r:'de'},{k:'„Éâ',r:'do'},
            {k:'„Éê',r:'ba'},{k:'„Éì',r:'bi'},{k:'„Éñ',r:'bu'},{k:'„Éô',r:'be'},{k:'„Éú',r:'bo'},
            {k:'„Éë',r:'pa'},{k:'„Éî',r:'pi'},{k:'„Éó',r:'pu'},{k:'„Éö',r:'pe'},{k:'„Éù',r:'po'}
        ];

        const KANA_GROUPS = {
            'Vocali': [0,5], 'K': [5,10], 'S': [10,15], 'T': [15,20], 'N': [20,25], 
            'H': [25,30], 'M': [30,35], 'Y': [35,38], 'R': [38,43], 'W/N': [43,46],
            'Dakuten': [46,71]
        };

        // --- STATO ---
        let vocaboli = [];
        let frasi = [];
        let sessione = [];
        let card = null;
        let punteggio = { ok:0, err:0 };
        let mode = 'vocab'; // 'vocab' o 'kana'

        // --- FUNZIONI ---
        function switchTab(id) {
            document.querySelectorAll('.modulo-content').forEach(d => d.classList.add('hidden'));
            document.getElementById('tab-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            if(id === 'quiz') {
                mode = 'vocab';
                document.getElementById('filtro-cat').classList.remove('hidden');
                nuovaSessione();
            }
        }

        function caricaDati() {
            try {
                if(localStorage.getItem('srs_vocab_v8')) vocaboli = JSON.parse(localStorage.getItem('srs_vocab_v8'));
                if(localStorage.getItem('srs_frasi_v8')) frasi = JSON.parse(localStorage.getItem('srs_frasi_v8'));
            } catch(e) {
                console.error("Errore lettura localStorage");
            }
            aggiornaConta();
            popolaFiltri();
            renderFrasi();
            if(vocaboli.length > 0) nuovaSessione();
            
            // Genera pulsanti Kana
            generaTastiConfig('h');
            generaTastiConfig('k');
        }

        function aggiornaConta() {
            document.getElementById('count-v').innerText = vocaboli.length;
            document.getElementById('count-f').innerText = frasi.length;
        }

        // --- KANA QUIZ SETUP ---
        function generaTastiConfig(prefix) {
            const container = document.getElementById(prefix+'-config');
            let html = '';
            for(let key in KANA_GROUPS) {
                html += `<label><input type="checkbox" value="${key}" checked> ${key}</label>`;
            }
            container.innerHTML = html;
        }

        function toggleKana(prefix, state) {
            document.querySelectorAll(`#${prefix}-config input`).forEach(c => c.checked = state);
        }

        function startKanaQuiz(prefix) {
            const dataset = (prefix==='h') ? RAW_HIRAGANA : RAW_KATAKANA;
            const checkboxes = document.querySelectorAll(`#${prefix}-config input:checked`);
            let pool = [];

            checkboxes.forEach(chk => {
                const range = KANA_GROUPS[chk.value];
                pool = pool.concat(dataset.slice(range[0], range[1]));
            });

            if(pool.length === 0) { alert("Seleziona almeno una riga"); return; }
            
            sessione = pool.sort(() => 0.5 - Math.random());
            mode = 'kana';
            switchTab('quiz');
            document.getElementById('filtro-cat').classList.add('hidden'); // Nascondi filtro vocab
            document.getElementById('quiz-area').classList.remove('hidden');
            document.getElementById('msg-no-data').classList.add('hidden');
            punteggio = {ok:0, err:0};
            prossima();
        }

        // --- QUIZ ENGINE ---
        function nuovaSessione() {
            if(mode === 'vocab') {
                const cat = document.getElementById('filtro-cat').value;
                const pool = (cat === 'TUTTI') ? vocaboli : vocaboli.filter(v => v.tag === cat);
                
                if(pool.length === 0) {
                    document.getElementById('quiz-area').classList.add('hidden');
                    document.getElementById('msg-no-data').classList.remove('hidden');
                    return;
                }
                document.getElementById('quiz-area').classList.remove('hidden');
                document.getElementById('msg-no-data').classList.add('hidden');
                
                sessione = pool.sort(() => 0.5 - Math.random()).slice(0, 10);
            }
            punteggio = { ok:0, err:0 };
            prossima();
        }

        function prossima() {
            if(sessione.length === 0) {
                document.getElementById('prompt-principale').innerText = "Fine Sessione!";
                document.getElementById('prompt-secondario').innerText = `Punteggio: ${punteggio.ok}/${punteggio.ok + punteggio.err}`;
                document.getElementById('input-risposta').classList.add('hidden');
                document.getElementById('btn-check').classList.add('hidden');
                document.getElementById('btn-next').classList.add('hidden');
                return;
            }

            card = sessione.pop();
            const input = document.getElementById('input-risposta');
            input.value = '';
            input.disabled = false;
            input.classList.remove('hidden');
            input.focus();

            document.getElementById('btn-check').classList.remove('hidden');
            document.getElementById('btn-next').classList.add('hidden');
            document.getElementById('risultato-controllo').innerText = '';

            if(mode === 'vocab') {
                const dir = Math.random() > 0.5 ? 'j2i' : 'i2j';
                card.dir = dir;
                if(dir === 'j2i') {
                    document.getElementById('q-label').innerText = "TRADUCI IN ITALIANO";
                    document.getElementById('prompt-principale').innerHTML = `${card.jpn} <span style="font-size:1rem; cursor:pointer" onclick="parla('${card.jpn}')">üîä</span>`;
                    document.getElementById('prompt-secondario').innerText = card.rom;
                } else {
                    document.getElementById('q-label').innerText = "TRADUCI IN GIAPPONESE (ROMAJI)";
                    document.getElementById('prompt-principale').innerText = card.ita;
                    document.getElementById('prompt-secondario').innerText = card.eng || "";
                }
            } else {
                document.getElementById('q-label').innerText = "SCRIVI IL ROMAJI";
                document.getElementById('prompt-principale').innerText = card.k;
                document.getElementById('prompt-secondario').innerText = "";
            }
        }

        function controlla() {
            const user = document.getElementById('input-risposta').value.trim().toLowerCase();
            let ok = false;
            let ans = "";

            if(mode === 'vocab') {
                if(card.dir === 'j2i') {
                    if(user == card.ita.toLowerCase() || (card.eng && user == card.eng.toLowerCase())) ok = true;
                    ans = card.ita;
                } else {
                    if(user == card.rom.toLowerCase() || user == card.jpn) ok = true;
                    ans = `${card.rom} (${card.jpn})`;
                }
            } else {
                if(user == card.r) ok = true;
                ans = card.r;
            }

            const res = document.getElementById('risultato-controllo');
            if(ok) {
                res.innerHTML = '<span class="corretto">Esatto!</span>';
                punteggio.ok++;
                if(mode==='vocab' && card.dir==='j2i') parla(card.jpn);
            } else {
                res.innerHTML = `<span class="sbagliato">Errato. Era: ${ans}</span>`;
                punteggio.err++;
            }

            document.getElementById('input-risposta').disabled = true;
            document.getElementById('btn-check').classList.add('hidden');
            document.getElementById('btn-next').classList.remove('hidden');
            document.getElementById('btn-next').focus();
        }

        // --- IMPORT/EXPORT ---
        function scarica(type) {
            const url = document.getElementById(type==='vocab'?'url-vocab':'url-frasi').value;
            if(!url) { alert("Link mancante"); return; }
            fetch(url).then(r=>r.text()).then(t => parseCSV(t, type)).catch(e => alert("Errore: "+e));
        }

        function leggiFile(input, type) {
            const f = input.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = e => parseCSV(e.target.result, type);
            r.readAsText(f);
        }

        function parseCSV(text, type) {
            const lines = text.trim().split(/\r?\n/);
            let count = 0;
            if(type === 'vocab') {
                vocaboli = [];
                lines.forEach(l => {
                    const p = l.split(',');
                    if(p.length >= 4) {
                        vocaboli.push({ita:p[0].trim(), eng:p[1].trim(), jpn:p[2].trim(), rom:p[3].trim(), tag:p[4]?p[4].trim():'Gen'});
                        count++;
                    }
                });
                localStorage.setItem('srs_vocab_v8', JSON.stringify(vocaboli));
            } else {
                frasi = [];
                lines.forEach(l => {
                    const p = l.split(',');
                    if(p.length >= 3) {
                        frasi.push({ita:p[0].trim(), rom:p[1].trim(), jpn:p[2].trim(), tag:p[3]?p[3].trim():'Gen'});
                        count++;
                    }
                });
                localStorage.setItem('srs_frasi_v8', JSON.stringify(frasi));
            }
            alert("Caricati: " + count);
            location.reload();
        }

        function resetTotale() {
            if(confirm("Sicuro?")) { localStorage.clear(); location.reload(); }
        }

        function popolaFiltri() {
            const s = document.getElementById('filtro-cat');
            s.innerHTML = '<option value="TUTTI">Tutte le Categorie</option>';
            const tags = new Set(vocaboli.map(v => v.tag));
            tags.forEach(t => s.innerHTML += `<option value="${t}">${t}</option>`);
        }

        function renderFrasi() {
            const div = document.getElementById('lista-frasi');
            const spoiler = document.getElementById('spoiler-check').checked;
            div.innerHTML = '';
            if(frasi.length === 0) { div.innerHTML = 'Nessuna frase'; return; }
            frasi.forEach(f => {
                div.innerHTML += `
                    <div class="frase-entry ${spoiler?'spoiler':''}">
                        <button class="play-btn" onclick="parla('${f.jpn.replace(/'/g,"\\'")} ')">‚ñ∂</button>
                        <div style="flex-grow:1">
                            <span style="font-weight:bold; display:block">${f.jpn}</span>
                            <span style="font-size:0.8rem; color:#888; display:block">${f.rom}</span>
                            <span class="frase-ita" style="color:#007aff; cursor:pointer">${f.ita}</span>
                        </div>
                    </div>
                `;
            });
        }

        function parla(t) {
            const u = new SpeechSynthesisUtterance(t);
            u.lang = 'ja-JP';
            window.speechSynthesis.speak(u);
        }

        // Inizializza tutto dopo che le funzioni sono definite
        caricaDati();

    </script>
</body>
</html>
