<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giapponese SRS v11.0 (Fix Kana Quiz)</title>
    <style>
        /* --- STILE GENERALE --- */
        body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        h1 { color: #1c1c1e; margin-bottom: 20px; text-align: center; }
        .container { width: 100%; max-width: 600px; margin-bottom: 50px; }
        .card { background: #ffffff; padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .hidden { display: none !important; }

        /* --- NOTIFICA SYNC --- */
        #sync-status {
            position: fixed; top: 10px; right: 10px; 
            padding: 10px 15px; border-radius: 20px; 
            font-size: 0.8rem; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none; z-index: 1000;
        }
        .sync-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .sync-loading { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }

        /* --- MENU --- */
        #main-nav { display: flex; gap: 8px; width: 100%; max-width: 600px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .nav-btn { flex: 1; padding: 12px; border: none; border-radius: 25px; background-color: #fff; color: #555; font-weight: 600; cursor: pointer; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s; }
        .nav-btn.active { background-color: #007aff; color: white; box-shadow: 0 4px 8px rgba(0,122,255,0.3); }

        /* --- UI --- */
        .input-box { width: 100%; padding: 12px; font-size: 1.1rem; border: 2px solid #ddd; border-radius: 12px; box-sizing: border-box; margin-bottom: 10px; text-align: center; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; color: white; margin-top: 5px; transition: 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-blue { background-color: #007aff; } .btn-green { background-color: #34c759; } .btn-red { background-color: #ff3b30; }

        /* --- QUIZ --- */
        #prompt-principale { font-size: 2.4rem; margin: 15px 0; text-align: center; font-weight: 500; }
        #prompt-secondario { font-size: 1.1rem; color: #666; text-align: center; margin-bottom: 20px; }
        #risultato-controllo { text-align: center; font-weight: bold; min-height: 30px; margin: 10px 0; font-size: 1.2rem; }
        .corretto { color: #34c759; } .sbagliato { color: #ff3b30; }

        /* --- ASCOLTO (CHAT LAYOUT) --- */
        .frase-entry { display: flex; align-items: flex-start; background: #ffffff; border-bottom: 1px solid #eee; padding: 15px 10px; gap: 15px; }
        .play-btn { width: 48px; height: 48px; border-radius: 50%; background: #007aff; color: white; border: none; font-size: 1.2rem; cursor: pointer; flex-shrink: 0; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 6px rgba(0,122,255,0.2); }
        .frase-text { flex-grow: 1; }
        .frase-jpn { font-weight: bold; font-size: 1.25rem; display: block; color: #333; margin-bottom: 4px; line-height: 1.4; }
        .frase-rom { font-size: 0.9rem; color: #888; display: block; margin-bottom: 6px; }
        .frase-ita { color: #007aff; font-size: 1rem; font-weight: 500; display: block; cursor: pointer; background: #f0f8ff; padding: 5px 8px; border-radius: 6px; display: inline-block; }
        .spoiler .frase-ita { background: #e0e0e0; color: transparent; }
        .spoiler .frase-ita:hover { background: #f0f8ff; color: #007aff; }

        /* --- KANA --- */
        .kana-table { width: 100%; border-collapse: collapse; text-align: center; margin-bottom: 20px; }
        .kana-table th { background: #f2f2f7; padding: 8px; font-size: 0.9rem; color: #666; }
        .kana-table td { border: 1px solid #eee; padding: 8px; font-size: 1.1rem; }
        .kc { font-weight: bold; display: block; color: #222; }
        .kr { font-size: 0.75rem; color: #999; }
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .checkbox-label { background: white; padding: 8px; border-radius: 8px; border: 1px solid #eee; display: flex; align-items: center; gap: 8px; }
    </style>
</head>
<body>

    <div id="sync-status"></div>
    <h1>Set di Studio Giapponese</h1>

    <nav id="main-nav">
        <button class="nav-btn active" onclick="switchTab('quiz'); openVocabQuiz()">Quiz Vocaboli</button>
        <button class="nav-btn" onclick="switchTab('ascolto')">Ascolto</button>
        <button class="nav-btn" onclick="switchTab('hiragana')">Hiragana</button>
        <button class="nav-btn" onclick="switchTab('katakana')">Katakana</button>
        <button class="nav-btn" onclick="switchTab('gestione')">Gestione</button>
    </nav>

    <div class="container">

        <div id="tab-quiz" class="modulo-content">
            <div class="card">
                <div style="text-align:center; margin-bottom:15px; color:#888; font-weight:bold;" id="punteggio">Pronto</div>
                
                <select id="filtro-cat" class="input-box" onchange="openVocabQuiz()"><option value="TUTTI">Tutte le Categorie</option></select>
                
                <div id="quiz-area">
                    <div style="text-align:center; color:#aaa; font-size:0.85rem; font-weight:bold; letter-spacing:1px;" id="q-label">DOMANDA</div>
                    <div id="prompt-principale">...</div>
                    <div id="prompt-secondario">...</div>
                    <input type="text" id="input-risposta" class="input-box" placeholder="Scrivi qui..." autocomplete="off">
                    <div id="risultato-controllo"></div>
                    <button id="btn-check" class="btn btn-blue" onclick="controlla()">Controlla</button>
                    <button id="btn-next" class="btn btn-green hidden" onclick="prossima()">Prossima</button>
                </div>
                <div id="msg-no-data" class="hidden" style="text-align:center; padding:20px;">
                    Caricamento dati in corso...<br>(O controlla i link in "Gestione")
                </div>
            </div>
        </div>

        <div id="tab-ascolto" class="modulo-content hidden">
            <div class="card">
                <h2 style="text-align:center; margin-bottom:20px;">Dialoghi & Frasi</h2>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <select id="filtro-frasi" class="input-box" style="margin:0;" onchange="renderFrasi()">
                        <option value="TUTTI">Tutti i Dialoghi</option>
                    </select>
                </div>
                <div style="text-align:center; margin-bottom:15px;">
                    <label style="cursor:pointer; color:#555;">
                        <input type="checkbox" id="spoiler-check" onchange="renderFrasi()"> Nascondi Italiano
                    </label>
                </div>
                <div id="lista-frasi"></div>
            </div>
        </div>

        <div id="tab-gestione" class="modulo-content hidden">
            <div class="card">
                <h2>Stato Dati</h2>
                <p>Vocaboli in memoria: <b id="count-v">0</b></p>
                <p>Frasi in memoria: <b id="count-f">0</b></p>
                <div style="margin-top:20px; padding-top:15px; border-top:1px solid #eee;">
                    <button class="btn btn-blue" onclick="forceSync()">ðŸ”„ Forza Aggiornamento</button>
                    <button class="btn btn-red" style="margin-top:10px;" onclick="resetTotale()">ðŸ—‘ Reset Completo</button>
                </div>
            </div>
        </div>

        <div id="tab-hiragana" class="modulo-content hidden">
            <div class="card">
                <h2>Hiragana</h2>
                <div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:20px;">
                    <div class="config-grid" id="h-config"></div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="btn btn-blue" style="padding:10px;" onclick="toggleKana('h', true)">Tutto</button>
                        <button class="btn btn-blue" style="padding:10px;" onclick="toggleKana('h', false)">Nulla</button>
                    </div>
                    <button class="btn btn-green" onclick="startKanaQuiz('h')">AVVIA QUIZ HIRAGANA</button>
                </div>
                <div style="overflow-x:auto;"><table class="kana-table" id="h-table"></table></div>
            </div>
        </div>

        <div id="tab-katakana" class="modulo-content hidden">
            <div class="card">
                <h2>Katakana</h2>
                <div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:20px;">
                    <div class="config-grid" id="k-config"></div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="btn btn-blue" style="padding:10px;" onclick="toggleKana('k', true)">Tutto</button>
                        <button class="btn btn-blue" style="padding:10px;" onclick="toggleKana('k', false)">Nulla</button>
                    </div>
                    <button class="btn btn-green" onclick="startKanaQuiz('k')">AVVIA QUIZ KATAKANA</button>
                </div>
                <div style="overflow-x:auto;"><table class="kana-table" id="k-table"></table></div>
            </div>
        </div>

    </div>

    <script>
        // === CONFIGURAZIONE LINK ===
        const LINK_VOCABOLI = "https://raw.githubusercontent.com/cecifabrizio-beep/japan/refs/heads/main/importa.csv";
        const LINK_FRASI = "https://raw.githubusercontent.com/cecifabrizio-beep/japan/refs/heads/main/frasi.csv";

        // --- DATASETS KANA ---
        const RAW_HIRAGANA=[{k:'ã‚',r:'a'},{k:'ã„',r:'i'},{k:'ã†',r:'u'},{k:'ãˆ',r:'e'},{k:'ãŠ',r:'o'},{k:'ã‹',r:'ka'},{k:'ã',r:'ki'},{k:'ã',r:'ku'},{k:'ã‘',r:'ke'},{k:'ã“',r:'ko'},{k:'ã•',r:'sa'},{k:'ã—',r:'shi'},{k:'ã™',r:'su'},{k:'ã›',r:'se'},{k:'ã',r:'so'},{k:'ãŸ',r:'ta'},{k:'ã¡',r:'chi'},{k:'ã¤',r:'tsu'},{k:'ã¦',r:'te'},{k:'ã¨',r:'to'},{k:'ãª',r:'na'},{k:'ã«',r:'ni'},{k:'ã¬',r:'nu'},{k:'ã­',r:'ne'},{k:'ã®',r:'no'},{k:'ã¯',r:'ha'},{k:'ã²',r:'hi'},{k:'ãµ',r:'fu'},{k:'ã¸',r:'he'},{k:'ã»',r:'ho'},{k:'ã¾',r:'ma'},{k:'ã¿',r:'mi'},{k:'ã‚€',r:'mu'},{k:'ã‚',r:'me'},{k:'ã‚‚',r:'mo'},{k:'ã‚„',r:'ya'},{k:'ã‚†',r:'yu'},{k:'ã‚ˆ',r:'yo'},{k:'ã‚‰',r:'ra'},{k:'ã‚Š',r:'ri'},{k:'ã‚‹',r:'ru'},{k:'ã‚Œ',r:'re'},{k:'ã‚',r:'ro'},{k:'ã‚',r:'wa'},{k:'ã‚’',r:'wo'},{k:'ã‚“',r:'n'},{k:'ãŒ',r:'ga'},{k:'ãŽ',r:'gi'},{k:'ã',r:'gu'},{k:'ã’',r:'ge'},{k:'ã”',r:'go'},{k:'ã–',r:'za'},{k:'ã˜',r:'ji'},{k:'ãš',r:'zu'},{k:'ãœ',r:'ze'},{k:'ãž',r:'zo'},{k:'ã ',r:'da'},{k:'ã¢',r:'ji'},{k:'ã¥',r:'zu'},{k:'ã§',r:'de'},{k:'ã©',r:'do'},{k:'ã°',r:'ba'},{k:'ã³',r:'bi'},{k:'ã¶',r:'bu'},{k:'ã¹',r:'be'},{k:'ã¼',r:'bo'},{k:'ã±',r:'pa'},{k:'ã´',r:'pi'},{k:'ã·',r:'pu'},{k:'ãº',r:'pe'},{k:'ã½',r:'po'},{k:'ãã‚ƒ',r:'kya'},{k:'ãã‚…',r:'kyu'},{k:'ãã‚‡',r:'kyo'},{k:'ã—ã‚ƒ',r:'sha'},{k:'ã—ã‚…',r:'shu'},{k:'ã—ã‚‡',r:'sho'},{k:'ã¡ã‚ƒ',r:'cha'},{k:'ã¡ã‚…',r:'chu'},{k:'ã¡ã‚‡',r:'cho'},{k:'ã«ã‚ƒ',r:'nya'},{k:'ã«ã‚…',r:'nyu'},{k:'ã«ã‚‡',r:'nyo'},{k:'ã²ã‚ƒ',r:'hya'},{k:'ã²ã‚…',r:'hyu'},{k:'ã²ã‚‡',r:'hyo'},{k:'ã¿ã‚ƒ',r:'mya'},{k:'ã¿ã‚…',r:'myu'},{k:'ã¿ã‚‡',r:'myo'},{k:'ã‚Šã‚ƒ',r:'rya'},{k:'ã‚Šã‚…',r:'ryu'},{k:'ã‚Šã‚‡',r:'ryo'},{k:'ãŽã‚ƒ',r:'gya'},{k:'ãŽã‚…',r:'gyu'},{k:'ãŽã‚‡',r:'gyo'},{k:'ã˜ã‚ƒ',r:'ja'},{k:'ã˜ã‚…',r:'ju'},{k:'ã˜ã‚‡',r:'jo'},{k:'ã³ã‚ƒ',r:'bya'},{k:'ã³ã‚…',r:'byu'},{k:'ã³ã‚‡',r:'byo'},{k:'ã´ã‚ƒ',r:'pya'},{k:'ã´ã‚…',r:'pyu'},{k:'ã´ã‚‡',r:'pyo'}];
        const RAW_KATAKANA=[{k:'ã‚¢',r:'a'},{k:'ã‚¤',r:'i'},{k:'ã‚¦',r:'u'},{k:'ã‚¨',r:'e'},{k:'ã‚ª',r:'o'},{k:'ã‚«',r:'ka'},{k:'ã‚­',r:'ki'},{k:'ã‚¯',r:'ku'},{k:'ã‚±',r:'ke'},{k:'ã‚³',r:'ko'},{k:'ã‚µ',r:'sa'},{k:'ã‚·',r:'shi'},{k:'ã‚¹',r:'su'},{k:'ã‚»',r:'se'},{k:'ã‚½',r:'so'},{k:'ã‚¿',r:'ta'},{k:'ãƒ',r:'chi'},{k:'ãƒ„',r:'tsu'},{k:'ãƒ†',r:'te'},{k:'ãƒˆ',r:'to'},{k:'ãƒŠ',r:'na'},{k:'ãƒ‹',r:'ni'},{k:'ãƒŒ',r:'nu'},{k:'ãƒ',r:'ne'},{k:'ãƒŽ',r:'no'},{k:'ãƒ',r:'ha'},{k:'ãƒ’',r:'hi'},{k:'ãƒ•',r:'fu'},{k:'ãƒ˜',r:'he'},{k:'ãƒ›',r:'ho'},{k:'ãƒž',r:'ma'},{k:'ãƒŸ',r:'mi'},{k:'ãƒ ',r:'mu'},{k:'ãƒ¡',r:'me'},{k:'ãƒ¢',r:'mo'},{k:'ãƒ¤',r:'ya'},{k:'ãƒ¦',r:'yu'},{k:'ãƒ¨',r:'yo'},{k:'ãƒ©',r:'ra'},{k:'ãƒª',r:'ri'},{k:'ãƒ«',r:'ru'},{k:'ãƒ¬',r:'re'},{k:'ãƒ­',r:'ro'},{k:'ãƒ¯',r:'wa'},{k:'ãƒ²',r:'wo'},{k:'ãƒ³',r:'n'},{k:'ã‚¬',r:'ga'},{k:'ã‚®',r:'gi'},{k:'ã‚°',r:'gu'},{k:'ã‚²',r:'ge'},{k:'ã‚´',r:'go'},{k:'ã‚¶',r:'za'},{k:'ã‚¸',r:'ji'},{k:'ã‚º',r:'zu'},{k:'ã‚¼',r:'ze'},{k:'ã‚¾',r:'zo'},{k:'ãƒ€',r:'da'},{k:'ãƒ‚',r:'ji'},{k:'ãƒ…',r:'zu'},{k:'ãƒ‡',r:'de'},{k:'ãƒ‰',r:'do'},{k:'ãƒ',r:'ba'},{k:'ãƒ“',r:'bi'},{k:'ãƒ–',r:'bu'},{k:'ãƒ™',r:'be'},{k:'ãƒœ',r:'bo'},{k:'ãƒ‘',r:'pa'},{k:'ãƒ”',r:'pi'},{k:'ãƒ—',r:'pu'},{k:'ãƒš',r:'pe'},{k:'ãƒ',r:'po'},{k:'ã‚­ãƒ£',r:'kya'},{k:'ã‚­ãƒ¥',r:'kyu'},{k:'ã‚­ãƒ§',r:'kyo'},{k:'ã‚·ãƒ£',r:'sha'},{k:'ã‚·ãƒ¥',r:'shu'},{k:'ã‚·ãƒ§',r:'sho'},{k:'ãƒãƒ£',r:'cha'},{k:'ãƒãƒ¥',r:'chu'},{k:'ãƒãƒ§',r:'cho'},{k:'ãƒ‹ãƒ£',r:'nya'},{k:'ãƒ‹ãƒ¥',r:'nyu'},{k:'ãƒ‹ãƒ§',r:'nyo'},{k:'ãƒ’ãƒ£',r:'hya'},{k:'ãƒ’ãƒ¥',r:'hyu'},{k:'ãƒ’ãƒ§',r:'hyo'},{k:'ãƒŸãƒ£',r:'mya'},{k:'ãƒŸãƒ¥',r:'myu'},{k:'ãƒŸãƒ§',r:'myo'},{k:'ãƒªãƒ£',r:'rya'},{k:'ãƒªãƒ¥',r:'ryu'},{k:'ãƒªãƒ§',r:'ryo'},{k:'ã‚®ãƒ£',r:'gya'},{k:'ã‚®ãƒ¥',r:'gyu'},{k:'ã‚®ãƒ§',r:'gyo'},{k:'ã‚¸ãƒ£',r:'ja'},{k:'ã‚¸ãƒ¥',r:'ju'},{k:'ã‚¸ãƒ§',r:'jo'},{k:'ãƒ“ãƒ£',r:'bya'},{k:'ãƒ“ãƒ¥',r:'byu'},{k:'ãƒ“ãƒ§',r:'byo'},{k:'ãƒ”ãƒ£',r:'pya'},{k:'ãƒ”ãƒ¥',r:'pyu'},{k:'ãƒ”ãƒ§',r:'pyo'}];
        const KANA_GROUPS = {'Vocali':[0,5],'K':[5,10],'S':[10,15],'T':[15,20],'N':[20,25],'H':[25,30],'M':[30,35],'Y':[35,38],'R':[38,43],'W/N':[43,46],'Dakuten':[46,71],'Yoon':[71,104]};

        // --- STATO ---
        let vocaboli = [];
        let frasi = [];
        let sessione = [];
        let card = null;
        let punteggio = { ok:0, err:0 };
        let mode = 'vocab'; 

        // --- AVVIO E SYNC ---
        window.onload = function() {
            try {
                if(localStorage.getItem('srs_vocab_v11')) vocaboli = JSON.parse(localStorage.getItem('srs_vocab_v11'));
                if(localStorage.getItem('srs_frasi_v11')) frasi = JSON.parse(localStorage.getItem('srs_frasi_v11'));
            } catch(e) { localStorage.clear(); }

            aggiornaConta();
            popolaFiltri();
            renderTabelle('h', RAW_HIRAGANA);
            renderTabelle('k', RAW_KATAKANA);
            renderFrasi();
            
            // Sync automatico
            if(LINK_VOCABOLI && LINK_FRASI) forceSync();

            document.getElementById('input-risposta').addEventListener('keydown', function(e){
                if(e.key === 'Enter') {
                    if(!document.getElementById('btn-check').classList.contains('hidden')) controlla();
                    else prossima();
                }
            });
        };

        function showNotification(msg, type) {
            const el = document.getElementById('sync-status');
            el.className = type; el.innerText = msg; el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 4000);
        }

        function forceSync() {
            showNotification("Sync...", "sync-loading");
            Promise.all([
                fetch(LINK_VOCABOLI).then(r=>r.text()),
                fetch(LINK_FRASI).then(r=>r.text())
            ]).then(([txtV, txtF]) => {
                parseCSV(txtV, 'vocab', false);
                parseCSV(txtF, 'frasi', false);
                showNotification("Dati Aggiornati!", "sync-success");
                aggiornaConta(); popolaFiltri(); renderFrasi();
                if(vocaboli.length > 0) openVocabQuiz(); // Avvia quiz se ci sono dati
            }).catch(e => {
                showNotification("Errore Sync", "sync-error");
            });
        }

        // --- NAVIGAZIONE ---
        function switchTab(id) {
            document.querySelectorAll('.modulo-content').forEach(d => d.classList.add('hidden'));
            document.getElementById('tab-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        // --- QUIZ FUNCTIONS ---
        function openVocabQuiz() {
            // Questa funzione imposta esplicitamente la modalitÃ  vocaboli
            mode = 'vocab';
            document.getElementById('filtro-cat').classList.remove('hidden');
            nuovaSessione();
        }

        function nuovaSessione() {
            if(mode === 'vocab') {
                const cat = document.getElementById('filtro-cat').value;
                const pool = (cat === 'TUTTI') ? vocaboli : vocaboli.filter(v => v.tag === cat);
                
                if(pool.length === 0) {
                    document.getElementById('quiz-area').classList.add('hidden');
                    document.getElementById('msg-no-data').classList.remove('hidden');
                    return;
                }
                document.getElementById('quiz-area').classList.remove('hidden');
                document.getElementById('msg-no-data').classList.add('hidden');
                sessione = pool.sort(() => 0.5 - Math.random()).slice(0, 10);
            }
            punteggio = { ok:0, err:0 };
            prossima();
        }

        function prossima() {
            if(sessione.length === 0) {
                document.getElementById('prompt-principale').innerText = "Fine Sessione!";
                document.getElementById('prompt-secondario').innerText = `Punteggio: ${punteggio.ok}/${punteggio.ok + punteggio.err}`;
                document.getElementById('input-risposta').classList.add('hidden');
                document.getElementById('btn-check').classList.add('hidden');
                document.getElementById('btn-next').classList.add('hidden');
                return;
            }

            card = sessione.pop();
            const input = document.getElementById('input-risposta');
            input.value = ''; input.disabled = false; input.classList.remove('hidden'); input.focus();

            document.getElementById('btn-check').classList.remove('hidden');
            document.getElementById('btn-next').classList.add('hidden');
            document.getElementById('risultato-controllo').innerText = '';

            if(mode === 'vocab') {
                const dir = Math.random() > 0.5 ? 'j2i' : 'i2j';
                card.dir = dir;
                if(dir === 'j2i') {
                    document.getElementById('q-label').innerText = "TRADUCI IN ITALIANO";
                    document.getElementById('prompt-principale').innerHTML = `${card.jpn} <span style="font-size:1.5rem; cursor:pointer;" onclick="parla('${card.jpn}')">ðŸ”Š</span>`;
                    document.getElementById('prompt-secondario').innerText = card.rom;
                } else {
                    document.getElementById('q-label').innerText = "TRADUCI IN GIAPPONESE (ROMAJI)";
                    document.getElementById('prompt-principale').innerText = card.ita;
                    document.getElementById('prompt-secondario').innerText = card.eng || "";
                }
            } else {
                document.getElementById('q-label').innerText = "SCRIVI IL ROMAJI";
                document.getElementById('prompt-principale').innerText = card.k;
                document.getElementById('prompt-secondario').innerText = "";
            }
        }

        function controlla() {
            const user = document.getElementById('input-risposta').value.trim().toLowerCase();
            let ok = false; let ans = "";

            if(mode === 'vocab') {
                if(card.dir === 'j2i') {
                    if(user == card.ita.toLowerCase() || (card.eng && user == card.eng.toLowerCase())) ok = true;
                    ans = card.ita;
                } else {
                    if(user == card.rom.toLowerCase() || user == card.jpn) ok = true;
                    ans = `${card.rom} (${card.jpn})`;
                }
            } else {
                if(user == card.r) ok = true;
                ans = card.r;
            }

            const res = document.getElementById('risultato-controllo');
            if(ok) {
                res.innerHTML = '<span class="corretto">Esatto!</span>';
                punteggio.ok++;
                if(mode==='vocab' && card.dir==='j2i') parla(card.jpn);
            } else {
                res.innerHTML = `<span class="sbagliato">Errato. Era: ${ans}</span>`;
                punteggio.err++;
            }

            document.getElementById('input-risposta').disabled = true;
            document.getElementById('btn-check').classList.add('hidden');
            document.getElementById('btn-next').classList.remove('hidden');
            document.getElementById('btn-next').focus();
        }

        // --- KANA ---
        function renderTabelle(prefix, data) {
            const t = document.getElementById(prefix+'-table');
            let html = '<tr>';
            for(let i=0; i<data.length; i++) {
                html += `<td><span class="kc">${data[i].k}</span><span class="kr">${data[i].r}</span></td>`;
                if((i+1)%5 === 0) html += '</tr><tr>';
            }
            t.innerHTML = html;

            const conf = document.getElementById(prefix+'-config');
            let chkHtml = '';
            for(let key in KANA_GROUPS) {
                chkHtml += `<label class="checkbox-label"><input type="checkbox" value="${key}" checked> ${key}</label>`;
            }
            conf.innerHTML = chkHtml;
        }

        function toggleKana(prefix, state) {
            document.querySelectorAll(`#${prefix}-config input`).forEach(c => c.checked = state);
        }

        function startKanaQuiz(prefix) {
            const dataset = (prefix==='h') ? RAW_HIRAGANA : RAW_KATAKANA;
            const checkboxes = document.querySelectorAll(`#${prefix}-config input:checked`);
            let pool = [];

            checkboxes.forEach(chk => {
                const range = KANA_GROUPS[chk.value];
                pool = pool.concat(dataset.slice(range[0], range[1]));
            });

            if(pool.length === 0) { alert("Seleziona almeno una riga"); return; }
            
            sessione = pool.sort(() => 0.5 - Math.random());
            
            // IMPOSTA LA MODALITA' KANA E CAMBIA SCHEDA
            mode = 'kana';
            switchTab('quiz');
            document.getElementById('filtro-cat').classList.add('hidden'); // Nasconde filtro vocaboli
            document.getElementById('quiz-area').classList.remove('hidden');
            document.getElementById('msg-no-data').classList.add('hidden');
            
            punteggio = {ok:0, err:0};
            prossima();
        }

        // --- PARSER ---
        function parseCSV(text, type, reload) {
            const lines = text.trim().split('\n');
            let count = 0;
            if(type === 'vocab') {
                vocaboli = [];
                lines.forEach(l => {
                    const sep = l.includes('|') ? '|' : ',';
                    const p = l.split(sep);
                    if(p.length >= 4) {
                        vocaboli.push({
                            ita:p[0].trim(), eng:p[1].trim(), jpn:p[2].trim(), 
                            rom:p[3].trim(), tag:p[4]?p[4].trim():'Gen'
                        });
                        count++;
                    }
                });
                localStorage.setItem('srs_vocab_v11', JSON.stringify(vocaboli));
            } else {
                frasi = [];
                lines.forEach(l => {
                    const sep = l.includes('|') ? '|' : ',';
                    const p = l.split(sep);
                    if(p.length >= 3) {
                        frasi.push({
                            ita:p[0].trim(), rom:p[1].trim(), jpn:p[2].trim(), 
                            tag:p[3]?p[3].trim():'Gen'
                        });
                        count++;
                    }
                });
                localStorage.setItem('srs_frasi_v11', JSON.stringify(frasi));
            }
            if(reload) { alert("Caricati: " + count); location.reload(); }
        }

        function resetTotale() {
            if(confirm("Sicuro?")) { localStorage.clear(); location.reload(); }
        }

        function aggiornaConta() {
            document.getElementById('count-v').innerText = vocaboli.length;
            document.getElementById('count-f').innerText = frasi.length;
        }

        function popolaFiltri() {
            const s = document.getElementById('filtro-cat');
            s.innerHTML = '<option value="TUTTI">Tutte le Categorie</option>';
            const tags = new Set(vocaboli.map(v => v.tag));
            tags.forEach(t => s.innerHTML += `<option value="${t}">${t}</option>`);

            const f = document.getElementById('filtro-frasi');
            f.innerHTML = '<option value="TUTTI">Tutti i Dialoghi</option>';
            const tagsF = new Set(frasi.map(v => v.tag));
            tagsF.forEach(t => f.innerHTML += `<option value="${t}">${t}</option>`);
        }

        function renderFrasi() {
            const div = document.getElementById('lista-frasi');
            const spoiler = document.getElementById('spoiler-check').checked;
            const filter = document.getElementById('filtro-frasi').value;
            div.innerHTML = '';
            
            const list = (filter === 'TUTTI') ? frasi : frasi.filter(f => f.tag === filter);
            if(list.length === 0) { div.innerHTML = '<p style="text-align:center">Nessuna frase</p>'; return; }
            
            list.forEach(f => {
                div.innerHTML += `
                    <div class="frase-entry ${spoiler?'spoiler':''}">
                        <button class="play-btn" onclick="parla('${f.jpn.replace(/'/g,"\\'")} ')">â–¶</button>
                        <div class="frase-text">
                            <span class="frase-jpn">${f.jpn}</span>
                            <span class="frase-rom">${f.rom}</span>
                            <span class="frase-ita">${f.ita}</span>
                        </div>
                    </div>
                `;
            });
        }

        function parla(t) {
            const u = new SpeechSynthesisUtterance(t);
            u.lang = 'ja-JP';
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>
